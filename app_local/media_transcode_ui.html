<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Media Transcode</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 0;
            min-height: 800px;
        }
        
        .panel {
            padding: 30px;
        }
        
        .panel:first-child {
            background: #f8f9fa;
            border-right: 1px solid #e9ecef;
        }
        
        .panel h2 {
            font-size: 1.3rem;
            margin-bottom: 20px;
            color: #495057;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* File Selection */
        .file-selection {
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }
        
        .file-selection:hover {
            border-color: #764ba2;
            background: rgba(102, 126, 234, 0.05);
        }
        
        .file-selection.dragover {
            border-color: #764ba2;
            background: rgba(102, 126, 234, 0.1);
        }
        
        .file-selection h3 {
            font-size: 1.1rem;
            margin-bottom: 10px;
            color: #667eea;
        }
        
        .file-selection p {
            font-size: 0.9rem;
            color: #6c757d;
            margin-bottom: 5px;
        }
        
        .selected-file {
            background: #e7f3ff;
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            font-size: 0.9rem;
        }
        
        /* Configuration Sections */
        .config-row-container {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }
        
        .config-sections-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }
        
        .config-section {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
        }
        
        .config-section.compact {
            padding: 15px;
        }
        
        .config-section h3 {
            font-size: 1rem;
            margin-bottom: 15px;
            color: #495057;
            font-weight: 600;
        }
        
        .config-form-compact {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .form-group-compact {
            display: flex;
            flex-direction: column;
        }
        
        .form-group-compact label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 4px;
            font-size: 0.85rem;
        }
        
        .form-group-compact input,
        .form-group-compact select {
            padding: 6px 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 0.85rem;
            width: 100%;
        }
        
        .form-group-compact input:focus,
        .form-group-compact select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }
        
        /* Media Type Toggle */
        .media-type-toggle {
            display: flex;
            background: #e9ecef;
            border-radius: 8px;
            padding: 4px;
            margin-bottom: 20px;
        }
        
        .media-type-btn {
            flex: 1;
            padding: 8px 16px;
            border: none;
            background: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .media-type-btn.active {
            background: #667eea;
            color: white;
        }
        
        /* Preset Buttons */
        .preset-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .preset-btn {
            padding: 10px;
            border: 2px solid #e9ecef;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 0.85rem;
        }
        
        .preset-btn:hover {
            border-color: #667eea;
            background: #f8f9fa;
        }
        
        .preset-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        /* Custom Presets */
        .custom-preset-btn {
            padding: 10px;
            border: 2px solid #28a745;
            background: #f8fff9;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 0.85rem;
            position: relative;
            margin: 5px;
            display: inline-block;
            min-width: 140px;
        }
        
        .custom-preset-btn:hover {
            border-color: #20c997;
            background: #e9f7ef;
        }
        
        .custom-preset-btn.active {
            background: #28a745;
            color: white;
            border-color: #28a745;
        }
        
        .custom-preset-btn .delete-preset {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
        
        .custom-preset-btn .delete-preset:hover {
            background: #c82333;
        }
        
        /* Template Modal Styles */
        .profile-block {
            margin-bottom: 20px;
            padding: 15px;
            background: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            position: relative;
        }
        
        .profile-block h4 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #495057;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .profile-delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        .profile-delete-btn:hover {
            background: #c82333;
        }
        
        .profile-fields {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .profile-fields label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #495057;
        }
        
        .profile-fields input, .profile-fields select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .config-editor {
            margin-top: 15px;
        }
        
        .config-editor label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }
        
        .config-editor textarea {
            width: 100%;
            height: 200px;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.85rem;
            background: #f8f9fa;
            resize: vertical;
        }
        
        .config-editor textarea:focus {
            outline: none;
            border-color: #007bff;
            background: #ffffff;
        }
        
        .template-status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: 600;
        }
        
        .template-status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .template-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .template-status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .convert-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }
        
        .convert-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .convert-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Results */
        .results {
            margin-top: 30px;
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .result-item {
            background: #f8f9fa;
            border-radius: 0;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
            border: 1px solid #dee2e6;
            position: relative;
        }
        
        .result-item:hover {
            transform: translateY(-5px);
        }
        
        .result-item img,
        .result-item video {
            width: 100%;
            height: auto;
            max-height: 400px;
            object-fit: contain;
            cursor: pointer;
            background: #f8f9fa;
        }
        
        .result-info {
            padding: 15px;
        }
        
        .result-info h4 {
            color: #495057;
            margin-bottom: 10px;
        }
        
        .result-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            font-size: 0.8rem;
        }
        
        .result-stat {
            display: flex;
            justify-content: space-between;
            padding: 4px 8px;
            background: white;
            border-radius: 3px;
        }
        
        .result-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .result-btn {
            padding: 4px 8px;
            font-size: 0.7rem;
            border: 1px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 3px;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s ease;
        }
        
        .result-btn:hover {
            background: #667eea;
            color: white;
        }
        
        .result-btn.danger {
            border-color: #dc3545;
            color: #dc3545;
        }
        
        .result-btn.danger:hover {
            background: #dc3545;
            color: white;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
        }
        
        .modal-content {
            position: relative;
            background-color: #fefefe;
            margin: 2% auto;
            padding: 0;
            border-radius: 10px;
            width: 95%;
            max-width: 1400px;
            max-height: 90vh;
            overflow: hidden;
        }
        
        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            z-index: 1001;
        }
        
        .modal-close:hover,
        .modal-close:focus {
            color: #333;
        }
        
        .modal-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
            height: 80vh;
        }
        
        .modal-media-section {
            padding: 20px;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            border-right: 1px solid #e9ecef;
            height: 100%;
            overflow: hidden;
        }
        
        .modal-media-section img,
        .modal-media-section video {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            object-fit: contain;
        }
        
        .modal-details-section {
            padding: 20px;
            background: white;
            overflow-y: auto;
            height: 100%;
        }
        
        .config-section {
            margin-bottom: 25px;
        }
        
        .config-section h3 {
            font-size: 1.2rem;
            color: #495057;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #667eea;
        }
        
        .config-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 15px;
        }
        
        .config-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 3px solid #667eea;
        }
        
        .config-label {
            font-weight: 600;
            color: #495057;
            font-size: 0.9rem;
        }
        
        .config-value {
            font-family: monospace;
            color: #007bff;
            background: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .modal-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        
        .modal-stat {
            background: #e7f3ff;
            padding: 12px;
            border-radius: 6px;
            text-align: center;
            border: 1px solid #b3d7ff;
        }
        
        .modal-stat-label {
            font-size: 0.75rem;
            color: #6c757d;
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .modal-stat-value {
            font-size: 1rem;
            color: #007bff;
            font-weight: 700;
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .modal-btn {
            padding: 10px 16px;
            border: 1px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            display: inline-block;
            font-weight: 500;
        }
        
        .modal-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-1px);
        }
        
        .modal-btn.danger {
            border-color: #dc3545;
            color: #dc3545;
        }
        
        .modal-btn.danger:hover {
            background: #dc3545;
            color: white;
        }
        
        @media (max-width: 768px) {
            .modal-grid {
                grid-template-columns: 1fr;
            }
            
            .modal-media-section {
                border-right: none;
                border-bottom: 1px solid #e9ecef;
            }
        }
        
        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #f5c6cb;
            border-left: 4px solid #dc3545;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.5;
            max-width: 100%;
            word-wrap: break-word;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .config-sections-row {
                grid-template-columns: 1fr;
            }
            
            .config-form-compact {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎬 Universal Media Transcode</h1>
            <p>Convert images to JPG and videos to MP4 with advanced settings</p>
        </div>
        
        <div class="main-grid">
            <!-- File Selection Panel -->
            <div class="panel">
                <h2>📁 Select Media File</h2>
                
                <!-- Media Type Toggle -->
                <div class="media-type-toggle">
                    <button class="media-type-btn active" data-type="auto">🔄 Auto</button>
                    <button class="media-type-btn" data-type="image">🖼️ Image</button>
                    <button class="media-type-btn" data-type="video">🎬 Video</button>
                </div>
                
                <div class="file-selection" id="fileSelection">
                    <div>
                        <h3>📂 Drop media file here or click to browse</h3>
                        <p><strong>Images:</strong> JPG, PNG, WebP, GIF, BMP</p>
                        <p><strong>Videos:</strong> MP4, MOV, AVI, MKV, WebM</p>
                    </div>
                    <div class="selected-file" id="selectedFile" style="display: none;"></div>
                </div>
                <input type="file" id="fileInput" accept="video/*,image/*" style="display: none;">
                
                <!-- Convert Button -->
                <button class="convert-btn" id="convertBtn" disabled>
                    🚀 Convert Media
                </button>
            </div>
            
            <!-- Configuration Panel -->
            <div class="panel">
                <h2>⚙️ Configuration</h2>
                
                <!-- Preset Management -->
                <div class="preset-management" style="margin-bottom: 20px;">
                    <!-- Default Presets -->
                    <div class="preset-buttons" id="presetButtons">
                        <!-- Will be populated by JavaScript -->
                    </div>
                    
                    <!-- Custom Presets -->
                    <div class="custom-presets" id="customPresets" style="margin-top: 15px;">
                        <!-- Custom presets will be loaded here -->
                    </div>
                    
                    <!-- Preset Controls -->
                    <div class="preset-controls" style="display: grid; grid-template-columns: 1fr auto auto auto; gap: 10px; margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 5px; border: 1px solid #dee2e6;">
                        <input type="text" id="presetName" placeholder="Enter preset name..." style="padding: 8px 12px; border: 1px solid #ced4da; border-radius: 4px; font-size: 0.9rem;">
                        <button id="savePresetBtn" style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 4px; font-size: 0.9rem; cursor: pointer; white-space: nowrap;">💾 Save Config</button>
                        <button id="createTemplateBtn" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; font-size: 0.9rem; cursor: pointer; white-space: nowrap;">🎨 New Template</button>
                        <button id="clearPresetsBtn" style="padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 4px; font-size: 0.9rem; cursor: pointer; white-space: nowrap;">🗑️ Clear All</button>
                    </div>
                </div>
                
                <div class="config-row-container">
                    <!-- Basic Settings Row -->
                    <div class="config-sections-row">
                        <!-- Common Settings -->
                        <div class="config-section compact">
                            <h3>🎯 Common Settings</h3>
                            <div class="config-form-compact">
                                <div class="form-group-compact">
                                    <label>Width</label>
                                    <input type="number" id="width" min="1" max="4096" placeholder="Auto">
                                </div>
                                
                                <div class="form-group-compact">
                                    <label>Height</label>
                                    <input type="number" id="height" min="1" max="4096" placeholder="Auto">
                                </div>
                                
                                <div class="form-group-compact">
                                    <label>Start Time (s)</label>
                                    <input type="number" id="startTime" min="0" value="0" step="0.1">
                                </div>
                                
                                <div class="form-group-compact" style="grid-column: 1 / -1;">
                                    <small style="color: #6c757d; font-style: italic;">
                                        💡 Quality settings are in specific sections below
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- Image Settings -->
                        <div class="config-section compact" id="imageSettings">
                            <h3>🖼️ Image Settings</h3>
                            <div class="config-form-compact">
                                <div class="form-group-compact">
                                    <label>JPEG Quality</label>
                                    <input type="number" id="jpegQuality" min="1" max="100" value="90">
                                </div>
                                
                                <div class="form-group-compact">
                                    <label>Optimize</label>
                                    <select id="optimize">
                                        <option value="true">Yes</option>
                                        <option value="false">No</option>
                                    </select>
                                </div>
                                
                                <div class="form-group-compact">
                                    <label>Progressive</label>
                                    <select id="progressive">
                                        <option value="false">No</option>
                                        <option value="true">Yes</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Video Settings -->
                        <div class="config-section compact" id="videoSettings" style="display: none;">
                            <h3>🎬 Video Settings</h3>
                            <div class="config-form-compact">
                                <div class="form-group-compact">
                                    <label>Codec</label>
                                    <select id="codec">
                                        <option value="h264">H.264</option>
                                        <option value="h265">H.265</option>
                                    </select>
                                </div>
                                
                                <div class="form-group-compact">
                                    <label>CRF (Quality)</label>
                                    <input type="number" id="crf" min="0" max="51" value="23" title="0=lossless, 23=default, 51=worst">
                                </div>
                                
                                <div class="form-group-compact">
                                    <label>Preset</label>
                                    <select id="preset">
                                        <option value="ultrafast">Ultra Fast</option>
                                        <option value="superfast">Super Fast</option>
                                        <option value="veryfast">Very Fast</option>
                                        <option value="faster">Faster</option>
                                        <option value="fast">Fast</option>
                                        <option value="medium" selected>Medium</option>
                                        <option value="slow">Slow</option>
                                        <option value="slower">Slower</option>
                                        <option value="veryslow">Very Slow</option>
                                    </select>
                                </div>
                                
                                <div class="form-group-compact">
                                    <label>FPS</label>
                                    <input type="number" id="fps" min="1" max="60" placeholder="Auto">
                                </div>
                                
                                <div class="form-group-compact">
                                    <label>Duration</label>
                                    <input type="number" id="duration" min="0.1" step="0.1" placeholder="Full">
                                </div>
                                
                                <div class="form-group-compact">
                                    <label>Bitrate</label>
                                    <input type="text" id="bitrate" placeholder="Auto (e.g. 2M)">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Advanced Settings Row -->
                    <div class="config-sections-row">
                        <!-- Color & Filters -->
                        <div class="config-section compact">
                            <h3>🎨 Color & Filters</h3>
                            <div class="config-form-compact">
                                <div class="form-group-compact">
                                    <label>Contrast</label>
                                    <input type="number" id="contrast" min="0" max="3" value="1.0" step="0.1">
                                </div>
                                
                                <div class="form-group-compact">
                                    <label>Brightness</label>
                                    <input type="number" id="brightness" min="-1" max="1" value="0.0" step="0.1">
                                </div>
                                
                                <div class="form-group-compact">
                                    <label>Saturation</label>
                                    <input type="number" id="saturation" min="0" max="3" value="1.0" step="0.1">
                                </div>
                                
                                <div class="form-group-compact">
                                    <label>Gamma</label>
                                    <input type="number" id="gamma" min="0.1" max="3" value="1.0" step="0.1">
                                </div>
                                
                                <div class="form-group-compact">
                                    <label>Denoise</label>
                                    <select id="denoising">
                                        <option value="false">No</option>
                                        <option value="true">Yes</option>
                                    </select>
                                </div>
                                
                                <div class="form-group-compact">
                                    <label>Sharpen</label>
                                    <select id="sharpening">
                                        <option value="false">No</option>
                                        <option value="true">Yes</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Video Advanced -->
                        <div class="config-section compact" id="videoAdvanced" style="display: none;">
                            <h3>⚙️ Video Advanced</h3>
                            <div class="config-form-compact">
                                <div class="form-group-compact">
                                    <label>Profile</label>
                                    <select id="profile">
                                        <option value="baseline">Baseline</option>
                                        <option value="main">Main</option>
                                        <option value="high" selected>High</option>
                                    </select>
                                </div>
                                
                                <div class="form-group-compact">
                                    <label>Level</label>
                                    <select id="level">
                                        <option value="3.1">3.1</option>
                                        <option value="4.0">4.0</option>
                                        <option value="4.1" selected>4.1</option>
                                        <option value="5.0">5.0</option>
                                        <option value="5.1">5.1</option>
                                    </select>
                                </div>
                                
                                <div class="form-group-compact">
                                    <label>Audio Codec</label>
                                    <select id="audioCodec">
                                        <option value="aac" selected>AAC</option>
                                        <option value="mp3">MP3</option>
                                        <option value="none">None</option>
                                    </select>
                                </div>
                                
                                <div class="form-group-compact">
                                    <label>Audio Bitrate</label>
                                    <select id="audioBitrate">
                                        <option value="96k">96k</option>
                                        <option value="128k" selected>128k</option>
                                        <option value="192k">192k</option>
                                        <option value="256k">256k</option>
                                    </select>
                                </div>
                                
                                <div class="form-group-compact">
                                    <label>Two Pass</label>
                                    <select id="twoPass">
                                        <option value="false">No</option>
                                        <option value="true">Yes</option>
                                    </select>
                                </div>
                                
                                <div class="form-group-compact">
                                    <label>HW Accel</label>
                                    <select id="hardwareAccel">
                                        <option value="false">No</option>
                                        <option value="true">Yes</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Audio Advanced (when image is selected) -->
                        <div class="config-section compact" id="audioAdvanced" style="display: none;">
                            <h3>🎵 Audio Settings</h3>
                            <div class="config-form-compact">
                                <div class="form-group-compact">
                                    <label>Audio Codec</label>
                                    <select id="audioCodec2">
                                        <option value="aac" selected>AAC</option>
                                        <option value="mp3">MP3</option>
                                        <option value="none">None</option>
                                    </select>
                                </div>
                                
                                <div class="form-group-compact">
                                    <label>Audio Bitrate</label>
                                    <select id="audioBitrate2">
                                        <option value="96k">96k</option>
                                        <option value="128k" selected>128k</option>
                                        <option value="192k">192k</option>
                                        <option value="256k">256k</option>
                                    </select>
                                </div>
                                
                                <div class="form-group-compact">
                                    <label>Sample Rate</label>
                                    <select id="audioSampleRate">
                                        <option value="22050">22.05 kHz</option>
                                        <option value="44100" selected>44.1 kHz</option>
                                        <option value="48000">48 kHz</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Converting media...</p>
        </div>

        <!-- Results Section -->
        <div class="panel status-panel">
            <h2>📤 Conversion Results</h2>
            
            <!-- Bulk Actions Controls -->
            <div class="bulk-controls" id="bulkControls" style="display: none; margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
                <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                    <label style="display: flex; align-items: center; gap: 5px; font-weight: 600; color: #495057;">
                        <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()">
                        Select All
                    </label>
                    <span id="selectedCount" style="color: #6c757d; font-size: 0.9rem;">0 selected</span>
                    <button id="deleteSelectedBtn" onclick="deleteSelected()" disabled style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 5px; font-size: 0.9rem; cursor: pointer; transition: background 0.3s ease;">
                        🗑️ Delete Selected
                    </button>
                    <button onclick="clearSelection()" style="background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 5px; font-size: 0.9rem; cursor: pointer;">
                        ✖️ Clear Selection
                    </button>
                </div>
            </div>
            
            <div class="results-grid" id="resultsGrid"></div>
        </div>

        <!-- Modal for viewing media with details -->
        <div class="modal" id="modal">
            <div class="modal-content">
                <span class="modal-close" id="modalClose">&times;</span>
                <div class="modal-grid">
                    <div class="modal-media-section">
                        <img id="modalImage" src="" alt="Modal Image" style="max-width: 100%; height: auto; display: none;">
                        <video id="modalVideo" src="" controls style="max-width: 100%; height: auto; display: none;"></video>
                    </div>
                    <div class="modal-details-section" id="modalDetails">
                        <!-- Configuration details will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Template Modal -->
    <div class="modal" id="createTemplateModal" style="display: none;">
        <div class="modal-content" style="width: 90%; max-width: 900px; max-height: 90vh; overflow: hidden;">
            <span class="modal-close" id="templateModalClose">&times;</span>
            <div style="padding: 20px; height: 80vh; overflow-y: auto;">
                <h2 style="margin-top: 0;">🎨 Create New Template</h2>
                
                <!-- Template Basic Info -->
                <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px; border: 1px solid #dee2e6;">
                    <h3 style="margin-top: 0;">📋 Template Information</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Template Name</label>
                            <input type="text" id="templateName" placeholder="e.g., my_custom_template" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Version</label>
                            <input type="text" id="templateVersion" placeholder="e.g., 2.0" value="2.0" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                        </div>
                        <div>
                            <button id="addProfileBtn" style="margin-top: 25px; width: 100%; padding: 8px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">➕ Add Profile</button>
                        </div>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Description</label>
                        <textarea id="templateDescription" placeholder="Describe what this template is for..." rows="2" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px; resize: vertical;"></textarea>
                    </div>
                </div>

                <!-- Profiles Container -->
                <div id="profilesContainer">
                    <!-- Profile blocks will be added here -->
                </div>

                <!-- Template Actions -->
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; padding-top: 20px; border-top: 1px solid #dee2e6;">
                    <button id="validateTemplateBtn" style="padding: 10px 20px; background: #ffc107; color: #000; border: none; border-radius: 4px; cursor: pointer;">🔍 Validate</button>
                    <button id="saveTemplateBtn" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">💾 Save Template</button>
                    <button id="cancelTemplateBtn" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">❌ Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let selectedFile = null;
        let currentMediaType = 'auto';
        let presets = {};
        let customPresets = {};
        let results = {}; // Store results for modal access
        let templateProfiles = []; // Store profiles for template creation

        // DOM elements
        const fileSelection = document.getElementById('fileSelection');
        const fileInput = document.getElementById('fileInput');
        const selectedFileDiv = document.getElementById('selectedFile');
        const convertBtn = document.getElementById('convertBtn');
        const loading = document.getElementById('loading');
        const resultsGrid = document.getElementById('resultsGrid');
        const presetButtons = document.getElementById('presetButtons');
        const customPresetsContainer = document.getElementById('customPresets');
        const presetNameInput = document.getElementById('presetName');
        const savePresetBtn = document.getElementById('savePresetBtn');
        const clearPresetsBtn = document.getElementById('clearPresetsBtn');
        
        // Template modal elements
        const createTemplateBtn = document.getElementById('createTemplateBtn');
        const createTemplateModal = document.getElementById('createTemplateModal');
        const templateModalClose = document.getElementById('templateModalClose');
        const addProfileBtn = document.getElementById('addProfileBtn');
        const profilesContainer = document.getElementById('profilesContainer');
        const validateTemplateBtn = document.getElementById('validateTemplateBtn');
        const saveTemplateBtn = document.getElementById('saveTemplateBtn');
        const cancelTemplateBtn = document.getElementById('cancelTemplateBtn');

        // Media type buttons
        const mediaTypeButtons = document.querySelectorAll('.media-type-btn');
        const imageSettings = document.getElementById('imageSettings');
        const videoSettings = document.getElementById('videoSettings');
        const videoAdvanced = document.getElementById('videoAdvanced');
        const audioAdvanced = document.getElementById('audioAdvanced');

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            setupModalEventListeners();
            setupCustomPresetListeners();
            setupTemplateModalListeners();
            loadPresets();
            loadCustomPresets();
            loadExistingResults();
        });

        function setupModalEventListeners() {
            const modal = document.getElementById('modal');
            const modalClose = document.getElementById('modalClose');

            // Close modal events
            modalClose.addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal();
                }
            });

            // ESC key to close modal
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && modal.style.display === 'block') {
                    closeModal();
                }
            });
        }

        function setupEventListeners() {
            // File selection
            fileSelection.addEventListener('click', () => fileInput.click());
            fileSelection.addEventListener('dragover', handleDragOver);
            fileSelection.addEventListener('dragleave', handleDragLeave);
            fileSelection.addEventListener('drop', handleDrop);
            fileInput.addEventListener('change', handleFileSelect);

            // Media type toggle
            mediaTypeButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    mediaTypeButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentMediaType = btn.dataset.type;
                    updateUIForMediaType();
                });
            });

            // Convert button
            convertBtn.addEventListener('click', convertMedia);
        }

        function updateUIForMediaType() {
            const isVideo = currentMediaType === 'video' || (currentMediaType === 'auto' && selectedFile && selectedFile.type.startsWith('video/'));
            const isImage = currentMediaType === 'image' || (currentMediaType === 'auto' && selectedFile && selectedFile.type.startsWith('image/'));

            imageSettings.style.display = isImage ? 'block' : 'none';
            videoSettings.style.display = isVideo ? 'block' : 'none';
            videoAdvanced.style.display = isVideo ? 'block' : 'none';
            audioAdvanced.style.display = 'none'; // Hide audio settings for both image and video

            updatePresets();
        }

        function handleDragOver(e) {
            e.preventDefault();
            fileSelection.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            fileSelection.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            fileSelection.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                selectFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            if (e.target.files.length > 0) {
                selectFile(e.target.files[0]);
            }
        }

        function selectFile(file) {
            // Auto-detect media type if set to auto
            if (currentMediaType === 'auto') {
                if (file.type.startsWith('video/')) {
                    document.querySelector('[data-type="video"]').click();
                } else if (file.type.startsWith('image/')) {
                    document.querySelector('[data-type="image"]').click();
                }
            }

            selectedFile = file;
            selectedFileDiv.style.display = 'block';
            selectedFileDiv.innerHTML = `
                <strong>Selected:</strong> ${file.name}<br>
                <strong>Size:</strong> ${formatFileSize(file.size)}<br>
                <strong>Type:</strong> ${file.type}
            `;
            convertBtn.disabled = false;
            updateUIForMediaType();
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        async function loadPresets() {
            try {
                const response = await fetch('/api/transcode/presets');
                const data = await response.json();
                presets = data.presets;
                updatePresets();
            } catch (error) {
                console.error('Failed to load presets:', error);
            }
        }

        function updatePresets() {
            presetButtons.innerHTML = '';
            
            const isVideo = currentMediaType === 'video' || (currentMediaType === 'auto' && selectedFile && selectedFile.type.startsWith('video/'));
            const prefix = isVideo ? 'video_' : 'image_';
            
            Object.entries(presets).forEach(([key, preset]) => {
                if (key.startsWith(prefix)) {
                    const btn = document.createElement('button');
                    btn.className = 'preset-btn';
                    btn.innerHTML = `
                        <strong>${preset.name}</strong><br>
                        <small>${preset.description}</small>
                    `;
                    btn.addEventListener('click', () => applyPreset(preset));
                    presetButtons.appendChild(btn);
                }
            });
        }

        function applyPreset(preset) {
            // Remove active class from all preset buttons
            document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.remove('active'));
            
            // Apply preset values
            Object.entries(preset).forEach(([key, value]) => {
                if (key !== 'name' && key !== 'description') {
                    const element = document.getElementById(key);
                    if (element) {
                        element.value = value;
                    }
                }
            });
            
            // Mark button as active
            event.target.closest('.preset-btn').classList.add('active');
        }

        async function convertMedia() {
            if (!selectedFile) return;

            const formData = new FormData();
            formData.append('media', selectedFile);

            // Collect all form data
            const formElements = document.querySelectorAll('input, select');
            formElements.forEach(element => {
                if (element.value !== '' && element.id) {
                    formData.append(element.id, element.value);
                }
            });

            // Show loading
            loading.style.display = 'block';
            convertBtn.disabled = true;

            try {
                const response = await fetch('/api/transcode', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();

                if (result.success) {
                    addResultToUI(result);
                } else {
                    // Handle empty error message
                    let errorMessage = result.error || 'Conversion failed';
                    
                    // Add command info for debugging if available
                    if (result.command) {
                        errorMessage += `\n\nCommand: ${result.command}`;
                    }
                    
                    // Add media type info
                    if (result.mediaType) {
                        errorMessage = `${result.mediaType.toUpperCase()} conversion failed: ${errorMessage}`;
                    }
                    
                    showError(errorMessage);
                    console.error('Conversion failed:', result);
                }
            } catch (error) {
                showError('Network error: ' + error.message);
                console.error('Request failed:', error);
            } finally {
                loading.style.display = 'none';
                convertBtn.disabled = false;
            }
        }

        function addResultToUI(result) {
            const resultItem = document.createElement('div');
            resultItem.className = 'result-item';
            
            const isVideo = result.mediaType === 'video';
            const mediaUrl = `/api/transcode/output/${result.outputFilename}`;
            const resultId = 'result_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            // Store result data
            results[resultId] = result;
            
            resultItem.innerHTML = `
                <!-- Selection Checkbox -->
                <div class="result-checkbox" style="position: absolute; top: 10px; left: 10px; z-index: 10;">
                    <input type="checkbox" class="result-select" data-filename="${result.outputFilename}" onchange="updateSelectionCount()" style="width: 18px; height: 18px; cursor: pointer;">
                </div>
                ${isVideo ? 
                    `<video src="${mediaUrl}" onclick="openModalWithDetails('${resultId}')" muted></video>` :
                    `<img src="${mediaUrl}" alt="${result.outputFilename}" onclick="openModalWithDetails('${resultId}')">` 
                }
                <div class="result-info">
                    <h4>${result.outputFilename}</h4>
                    <div class="result-stats">
                        <div class="result-stat">
                            <span>Size:</span>
                            <span>${result.fileSizeMB.toFixed(2)} MB</span>
                        </div>
                        <div class="result-stat">
                            <span>Dimensions:</span>
                            <span>${result.actualDimensions}</span>
                        </div>
                        <div class="result-stat">
                            <span>Type:</span>
                            <span>${isVideo ? 'MP4' : 'JPG'}</span>
                        </div>
                        <div class="result-stat">
                            <span>Time:</span>
                            <span>${result.conversionTime.toFixed(1)}s</span>
                        </div>
                        ${result.codec ? `<div class="result-stat">
                            <span>Codec:</span>
                            <span>${result.codec}</span>
                        </div>` : ''}
                        ${result.quality ? `<div class="result-stat">
                            <span>Quality:</span>
                            <span>${result.quality}</span>
                        </div>` : ''}
                    </div>
                    <div class="result-actions">
                        <a href="${mediaUrl}" download class="result-btn">📥 Download</a>
                        <button class="result-btn" onclick="copyConfig('${result.outputFilename}')">📋 Copy</button>
                        <button class="result-btn danger" onclick="deleteResult('${result.outputFilename}')">🗑️ Delete</button>
                    </div>
                </div>
            `;
            
            resultsGrid.insertBefore(resultItem, resultsGrid.firstChild);
            
            // Show bulk controls if this is the first result
            updateBulkControlsVisibility();
        }

        // Modal functions
        function openModal(src) {
            const modal = document.getElementById('modal');
            const modalImage = document.getElementById('modalImage');
            const modalVideo = document.getElementById('modalVideo');
            const modalDetails = document.getElementById('modalDetails');
            
            // Clear details section for simple view
            modalDetails.innerHTML = '';
            
            // Check if it's a video or image
            if (src.includes('.mp4') || src.includes('.webm') || src.includes('.mov')) {
                modalVideo.src = src;
                modalVideo.style.display = 'block';
                modalImage.style.display = 'none';
            } else {
                modalImage.src = src;
                modalImage.style.display = 'block';
                modalVideo.style.display = 'none';
            }
            
            modal.style.display = 'block';
        }

        function openModalWithDetails(resultId) {
            const result = results[resultId];
            if (!result) return;
            
            const modal = document.getElementById('modal');
            const modalImage = document.getElementById('modalImage');
            const modalVideo = document.getElementById('modalVideo');
            const modalDetails = document.getElementById('modalDetails');
            
            const isVideo = result.mediaType === 'video';
            const mediaUrl = `/api/transcode/output/${result.outputFilename}`;
            
            // Display media
            if (isVideo) {
                modalVideo.src = mediaUrl;
                modalVideo.style.display = 'block';
                modalImage.style.display = 'none';
            } else {
                modalImage.src = mediaUrl;
                modalImage.style.display = 'block';
                modalVideo.style.display = 'none';
            }
            
            // Display details
            modalDetails.innerHTML = `
                <h2 style="margin-bottom: 20px; color: #495057;">${result.outputFilename}</h2>
                
                <div class="modal-stats">
                    <div class="modal-stat">
                        <div class="modal-stat-label">Type</div>
                        <div class="modal-stat-value">${result.mediaType.toUpperCase()}</div>
                    </div>
                    <div class="modal-stat">
                        <div class="modal-stat-label">Size</div>
                        <div class="modal-stat-value">${result.fileSizeMB.toFixed(2)} MB</div>
                    </div>
                    <div class="modal-stat">
                        <div class="modal-stat-label">Dimensions</div>
                        <div class="modal-stat-value">${result.actualDimensions}</div>
                    </div>
                    <div class="modal-stat">
                        <div class="modal-stat-label">Time</div>
                        <div class="modal-stat-value">${result.conversionTime.toFixed(1)}s</div>
                    </div>
                    ${result.codec ? `<div class="modal-stat">
                        <div class="modal-stat-label">Codec</div>
                        <div class="modal-stat-value">${result.codec}</div>
                    </div>` : ''}
                    ${isVideo && result.duration ? `<div class="modal-stat">
                        <div class="modal-stat-label">Duration</div>
                        <div class="modal-stat-value">${result.duration.toFixed(1)}s</div>
                    </div>` : ''}
                    ${isVideo && result.fps ? `<div class="modal-stat">
                        <div class="modal-stat-label">FPS</div>
                        <div class="modal-stat-value">${result.fps.toFixed(1)}</div>
                    </div>` : ''}
                    ${isVideo && result.bitRate ? `<div class="modal-stat">
                        <div class="modal-stat-label">Bitrate</div>
                        <div class="modal-stat-value">${(result.bitRate / 1000).toFixed(0)} kbps</div>
                    </div>` : ''}
                </div>
                
                <div class="modal-actions">
                    <a href="${mediaUrl}" download class="modal-btn">📥 Download</a>
                    <button class="modal-btn" onclick="copyConfig('${result.outputFilename}')">📋 Copy Config</button>
                    <button class="modal-btn danger" onclick="deleteResult('${result.outputFilename}'); closeModal();">🗑️ Delete</button>
                </div>
                
                <div class="config-section">
                    <h3>⚙️ Configuration Used</h3>
                    <div class="config-grid">
                        ${generateConfigDisplay(result.config, result.mediaType)}
                    </div>
                </div>
                
                <details style="margin-top: 20px;">
                    <summary style="cursor: pointer; font-weight: 600; color: #495057;">📋 Raw JSON Configuration</summary>
                    <pre style="background: #f8f9fa; padding: 15px; border-radius: 5px; font-size: 0.8rem; overflow: auto; margin-top: 10px; border: 1px solid #e9ecef;">${JSON.stringify(filterConfigForMediaType(result.config, result.mediaType), null, 2)}</pre>
                </details>
            `;
            
            modal.style.display = 'block';
        }

        function getRelevantSettingsForMediaType(mediaType) {
            // Note: 'quality' is NOT included because it's not actually used by backend
            // Image uses 'jpegQuality', Video uses 'crf'
            const imageSettings = ['width', 'height', 'startTime', 'jpegQuality', 'optimize', 'progressive', 
                                 'contrast', 'brightness', 'saturation', 'gamma', 'denoising', 'sharpening'];
            
            const videoSettings = ['width', 'height', 'startTime', 'codec', 'crf', 'preset', 'fps', 'duration', 
                                 'bitrate', 'profile', 'level', 'audioCodec', 'audioBitrate', 'twoPass', 'hardwareAccel',
                                 'contrast', 'brightness', 'saturation', 'gamma', 'denoising', 'sharpening'];
            
            return mediaType === 'video' ? videoSettings : imageSettings;
        }

        function filterConfigForMediaType(config, mediaType) {
            const relevantSettings = getRelevantSettingsForMediaType(mediaType);
            const filteredConfig = {};
            
            Object.entries(config).forEach(([key, value]) => {
                if (relevantSettings.includes(key) && value !== null && value !== undefined && value !== '' && value !== false) {
                    filteredConfig[key] = value;
                }
            });
            
            return filteredConfig;
        }

        function generateConfigDisplay(config, mediaType) {
            const relevantSettings = getRelevantSettingsForMediaType(mediaType);
            
            return Object.entries(config).map(([key, value]) => {
                // Skip if not relevant for this media type
                if (!relevantSettings.includes(key)) return '';
                
                // Skip empty/false/null values
                if (value === null || value === undefined || value === '' || value === false) return '';
                
                const label = key.charAt(0).toUpperCase() + key.slice(1).replace(/([A-Z])/g, ' $1');
                return `
                    <div class="config-item">
                        <span class="config-label">${label}:</span>
                        <span class="config-value">${value === true ? 'Yes' : value}</span>
                    </div>
                `;
            }).filter(item => item !== '').join('');
        }
        
        function closeModal() {
            const modal = document.getElementById('modal');
            const modalImage = document.getElementById('modalImage');
            const modalVideo = document.getElementById('modalVideo');
            
            modal.style.display = 'none';
            modalImage.src = '';
            modalVideo.src = '';
            modalVideo.pause();
        }
        
        function copyConfig(filename) {
            // Find the result data
            const result = Object.values(results).find(r => r.outputFilename === filename);
            if (!result) {
                alert('Configuration not found');
                return;
            }
            
            // Apply the configuration to the current form
            const config = result.config;
            applyConfigToForm(config);
            
            // Show success message
            const successDiv = document.createElement('div');
            successDiv.className = 'status success';
            successDiv.style.position = 'fixed';
            successDiv.style.top = '20px';
            successDiv.style.right = '20px';
            successDiv.style.zIndex = '1000';
            successDiv.style.padding = '10px 15px';
            successDiv.style.background = '#d4edda';
            successDiv.style.color = '#155724';
            successDiv.style.border = '1px solid #c3e6cb';
            successDiv.style.borderRadius = '5px';
            successDiv.textContent = '📋 Configuration copied to form!';
            document.body.appendChild(successDiv);
            
            setTimeout(() => {
                successDiv.remove();
            }, 3000);
        }
        
        function deleteResult(filename) {
            if (confirm('Are you sure you want to delete this result?')) {
                const resultItems = document.querySelectorAll('.result-item');
                resultItems.forEach(item => {
                    if (item.innerHTML.includes(filename)) {
                        item.remove();
                    }
                });
                
                // Call backend to delete file
                fetch(`/api/transcode/output/${filename}`, { method: 'DELETE' })
                    .then(response => response.json())
                    .then(data => console.log('File deleted:', data))
                    .catch(error => console.error('Delete error:', error));
            }
        }

        async function loadExistingResults() {
            try {
                const response = await fetch('/api/transcode/files');
                const data = await response.json();
                
                // This would load existing files on page load
                // Implementation similar to WebP converter
            } catch (error) {
                console.error('Failed to load existing results:', error);
            }
        }

        // Custom Presets Management Functions
        function setupCustomPresetListeners() {
            savePresetBtn.addEventListener('click', saveCustomPreset);
            clearPresetsBtn.addEventListener('click', clearAllCustomPresets);
            presetNameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    saveCustomPreset();
                }
            });
        }

        function loadCustomPresets() {
            const saved = localStorage.getItem('universal-media-custom-presets');
            if (saved) {
                try {
                    customPresets = JSON.parse(saved);
                    renderCustomPresets();
                } catch (error) {
                    console.error('Failed to load custom presets:', error);
                    customPresets = {};
                }
            }
        }
        
        function saveCustomPresets() {
            localStorage.setItem('universal-media-custom-presets', JSON.stringify(customPresets));
        }
        
        function getCurrentConfig() {
            // Helper function to safely parse numbers
            const safeParseInt = (value, defaultValue = null) => {
                const parsed = parseInt(value);
                return isNaN(parsed) ? defaultValue : parsed;
            };
            
            const safeParseFloat = (value, defaultValue = null) => {
                const parsed = parseFloat(value);
                return isNaN(parsed) ? defaultValue : parsed;
            };
            
            // Detect output format based on current media type and settings
            let output_format = 'webp'; // default
            
            if (currentMediaType === 'image') {
                // Check if JPEG quality is set (indicates JPG output)
                const jpegQuality = document.getElementById('jpegQuality')?.value;
                if (jpegQuality && jpegQuality !== '') {
                    output_format = 'jpg';
                }
            } else if (currentMediaType === 'video') {
                // Video mode defaults to MP4
                output_format = 'mp4';
            }
            // Auto mode: keep webp as default for compatibility
            
            const config = {
                // Output format (auto-detected)
                output_format: output_format,
                
                // Common settings
                width: safeParseInt(document.getElementById('width')?.value),
                height: safeParseInt(document.getElementById('height')?.value),
                startTime: safeParseFloat(document.getElementById('startTime')?.value, 0),
                
                // Image settings (if visible)
                jpegQuality: safeParseInt(document.getElementById('jpegQuality')?.value, 90),
                optimize: document.getElementById('optimize')?.value === 'true',
                progressive: document.getElementById('progressive')?.value === 'true',
                
                // Video settings (if visible)
                codec: document.getElementById('codec')?.value,
                crf: safeParseInt(document.getElementById('crf')?.value, 23),
                preset: document.getElementById('preset')?.value,
                fps: safeParseInt(document.getElementById('fps')?.value),
                duration: (() => {
                    const val = document.getElementById('duration')?.value;
                    return val === '' || val === '0' ? null : safeParseFloat(val);
                })(),
                bitrate: document.getElementById('bitrate')?.value,
                
                // Color & Filters
                contrast: safeParseFloat(document.getElementById('contrast')?.value, 1.0),
                brightness: safeParseFloat(document.getElementById('brightness')?.value, 0.0),
                saturation: safeParseFloat(document.getElementById('saturation')?.value, 1.0),
                gamma: safeParseFloat(document.getElementById('gamma')?.value, 1.0),
                denoising: document.getElementById('denoising')?.value === 'true',
                sharpening: document.getElementById('sharpening')?.value === 'true',
                
                // Video Advanced (if visible)
                profile: document.getElementById('profile')?.value,
                level: document.getElementById('level')?.value,
                audioCodec: document.getElementById('audioCodec')?.value,
                audioBitrate: document.getElementById('audioBitrate')?.value,
                twoPass: document.getElementById('twoPass')?.value === 'true',
                hardwareAccel: document.getElementById('hardwareAccel')?.value === 'true',
                
                // Store current media type for proper restore
                mediaType: currentMediaType
            };
            
            // Remove null/undefined values
            Object.keys(config).forEach(key => {
                if (config[key] === null || config[key] === undefined) {
                    delete config[key];
                }
            });
            
            return config;
        }
        
        function applyConfigToForm(config) {
            // Auto-detect and switch media type based on output_format
            if (config.output_format) {
                let targetMediaType = currentMediaType;
                
                if (config.output_format === 'mp4') {
                    targetMediaType = 'video';
                } else if (config.output_format === 'jpg' || config.output_format === 'jpeg') {
                    targetMediaType = 'image';
                } else if (config.output_format === 'webp') {
                    // WebP can be either, keep current or default to auto
                    targetMediaType = config.mediaType || 'auto';
                }
                
                if (targetMediaType !== currentMediaType) {
                    const mediaTypeBtn = document.querySelector(`[data-type="${targetMediaType}"]`);
                    if (mediaTypeBtn) {
                        mediaTypeBtn.click();
                    }
                }
            }
            
            // Legacy: Switch to the correct media type first (for backward compatibility)
            if (config.mediaType && config.mediaType !== currentMediaType) {
                const mediaTypeBtn = document.querySelector(`[data-type="${config.mediaType}"]`);
                if (mediaTypeBtn) {
                    mediaTypeBtn.click();
                }
            }
            
            // Apply common settings
            if (config.width) document.getElementById('width').value = config.width;
            if (config.height) document.getElementById('height').value = config.height;
            if (config.startTime !== undefined) document.getElementById('startTime').value = config.startTime;
            
            // Apply image settings
            if (config.jpegQuality) document.getElementById('jpegQuality').value = config.jpegQuality;
            if (config.optimize !== undefined) document.getElementById('optimize').value = config.optimize.toString();
            if (config.progressive !== undefined) document.getElementById('progressive').value = config.progressive.toString();
            
            // Apply video settings
            if (config.codec) document.getElementById('codec').value = config.codec;
            if (config.crf) document.getElementById('crf').value = config.crf;
            if (config.preset) document.getElementById('preset').value = config.preset;
            if (config.fps) document.getElementById('fps').value = config.fps;
            if (config.duration) document.getElementById('duration').value = config.duration;
            if (config.bitrate) document.getElementById('bitrate').value = config.bitrate;
            
            // Apply color & filters
            if (config.contrast) document.getElementById('contrast').value = config.contrast;
            if (config.brightness) document.getElementById('brightness').value = config.brightness;
            if (config.saturation) document.getElementById('saturation').value = config.saturation;
            if (config.gamma) document.getElementById('gamma').value = config.gamma;
            if (config.denoising !== undefined) document.getElementById('denoising').value = config.denoising.toString();
            if (config.sharpening !== undefined) document.getElementById('sharpening').value = config.sharpening.toString();
            
            // Apply video advanced
            if (config.profile) document.getElementById('profile').value = config.profile;
            if (config.level) document.getElementById('level').value = config.level;
            if (config.audioCodec) document.getElementById('audioCodec').value = config.audioCodec;
            if (config.audioBitrate) document.getElementById('audioBitrate').value = config.audioBitrate;
            if (config.twoPass !== undefined) document.getElementById('twoPass').value = config.twoPass.toString();
            if (config.hardwareAccel !== undefined) document.getElementById('hardwareAccel').value = config.hardwareAccel.toString();
        }
        
        function saveCustomPreset() {
            const name = presetNameInput.value.trim();
            if (!name) {
                alert('Please enter a preset name');
                return;
            }
            
            // Check if it conflicts with default presets
            const defaultPresetNames = Object.keys(presets);
            if (defaultPresetNames.includes(name)) {
                alert('Cannot overwrite default presets. Please choose a different name.');
                return;
            }
            
            const config = getCurrentConfig();
            customPresets[name] = {
                name: name,
                ...config,
                created: new Date().toISOString()
            };
            
            saveCustomPresets();
            renderCustomPresets();
            presetNameInput.value = '';
            
            // Show success message
            const successDiv = document.createElement('div');
            successDiv.className = 'status success';
            successDiv.style.position = 'fixed';
            successDiv.style.top = '20px';
            successDiv.style.right = '20px';
            successDiv.style.zIndex = '1000';
            successDiv.style.padding = '10px 15px';
            successDiv.style.background = '#d4edda';
            successDiv.style.color = '#155724';
            successDiv.style.border = '1px solid #c3e6cb';
            successDiv.style.borderRadius = '5px';
            successDiv.textContent = `✅ Preset "${name}" saved successfully!`;
            document.body.appendChild(successDiv);
            
            setTimeout(() => {
                successDiv.remove();
            }, 3000);
        }
        
        function deleteCustomPreset(name) {
            if (confirm(`Are you sure you want to delete preset "${name}"?`)) {
                delete customPresets[name];
                saveCustomPresets();
                renderCustomPresets();
            }
        }
        
        function clearAllCustomPresets() {
            if (confirm('Are you sure you want to delete all custom presets? This cannot be undone.')) {
                customPresets = {};
                saveCustomPresets();
                renderCustomPresets();
            }
        }
        
        function renderCustomPresets() {
            customPresetsContainer.innerHTML = '';
            
            Object.entries(customPresets).forEach(([key, preset]) => {
                const btn = document.createElement('div');
                btn.className = 'custom-preset-btn';
                btn.dataset.preset = key;
                
                // Create preset description based on media type
                const isVideo = preset.mediaType === 'video';
                const description = isVideo 
                    ? `${preset.width || 'Auto'}px, ${preset.codec || 'H264'}, CRF${preset.crf || 23}`
                    : `${preset.width || 'Auto'}px, Q${preset.jpegQuality || 90}`;
                
                btn.innerHTML = `
                    <strong>🎛️ ${preset.name}</strong><br>
                    <small>${description}</small>
                `;
                
                // Create delete button
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-preset';
                deleteBtn.innerHTML = '×';
                deleteBtn.title = 'Delete preset';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    deleteCustomPreset(key);
                };
                btn.appendChild(deleteBtn);
                
                // Add click event for preset selection
                btn.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('delete-preset')) {
                        // Clear all active states
                        document.querySelectorAll('.preset-btn, .custom-preset-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        applyConfigToForm(preset);
                    }
                });
                
                customPresetsContainer.appendChild(btn);
            });
            
            // Show/hide custom presets section
            customPresetsContainer.style.display = Object.keys(customPresets).length > 0 ? 'block' : 'none';
        }

        // Template Modal Functions
        function setupTemplateModalListeners() {
            createTemplateBtn.addEventListener('click', openTemplateModal);
            templateModalClose.addEventListener('click', closeTemplateModal);
            addProfileBtn.addEventListener('click', addProfileBlock);
            validateTemplateBtn.addEventListener('click', validateTemplate);
            saveTemplateBtn.addEventListener('click', saveTemplate);
            cancelTemplateBtn.addEventListener('click', closeTemplateModal);
            
            // Close modal when clicking outside
            createTemplateModal.addEventListener('click', (e) => {
                if (e.target === createTemplateModal) {
                    closeTemplateModal();
                }
            });
        }
        
        function openTemplateModal() {
            templateProfiles = [];
            document.getElementById('templateName').value = '';
            document.getElementById('templateVersion').value = '2.0';
            document.getElementById('templateDescription').value = '';
            profilesContainer.innerHTML = '';
            createTemplateModal.style.display = 'block';
            addProfileBlock(); // Start with one profile
        }
        
        function closeTemplateModal() {
            createTemplateModal.style.display = 'none';
            templateProfiles = [];
            removeTemplateStatus();
        }
        
        function addProfileBlock() {
            const profileId = `profile_${templateProfiles.length}`;
            const profileIndex = templateProfiles.length;
            
            const profileBlock = document.createElement('div');
            profileBlock.className = 'profile-block';
            profileBlock.id = `profile_${profileIndex}`;
            
            profileBlock.innerHTML = `
                <h4>
                    🎯 Profile ${profileIndex + 1}
                    <button class="profile-delete-btn" onclick="removeProfileBlock(${profileIndex})">🗑️ Remove</button>
                </h4>
                
                <div class="profile-fields">
                    <div>
                        <label>Profile ID</label>
                        <input type="text" id="profileId_${profileIndex}" placeholder="e.g., webp_preview_high" required>
                    </div>
                    <div>
                        <label>Input Type</label>
                        <select id="inputType_${profileIndex}">
                            <option value="">Any</option>
                            <option value="video">Video</option>
                            <option value="image">Image</option>
                        </select>
                    </div>
                    <div>
                        <label>Output Filename</label>
                        <input type="text" id="outputFilename_${profileIndex}" placeholder="e.g., preview_hd">
                    </div>
                </div>
                
                <div class="config-editor">
                    <label>Configuration (JSON)</label>
                    <textarea id="config_${profileIndex}" placeholder='Paste your config JSON here, e.g.:
{
  "output_format": "webp",
  "width": 720,
  "quality": 85,
  "fps": 12.0,
  "duration": 3.0,
  "animated": true,
  "lossless": false
}'></textarea>
                </div>
            `;
            
            profilesContainer.appendChild(profileBlock);
            templateProfiles.push({
                index: profileIndex,
                block: profileBlock
            });
        }
        
        function removeProfileBlock(profileIndex) {
            const profileBlock = document.getElementById(`profile_${profileIndex}`);
            if (profileBlock) {
                profileBlock.remove();
                // Update templateProfiles array
                templateProfiles = templateProfiles.filter(p => p.index !== profileIndex);
                // Re-number remaining profiles
                updateProfileNumbers();
            }
        }
        
        function updateProfileNumbers() {
            const remainingBlocks = document.querySelectorAll('.profile-block');
            remainingBlocks.forEach((block, index) => {
                const header = block.querySelector('h4');
                header.innerHTML = `
                    🎯 Profile ${index + 1}
                    <button class="profile-delete-btn" onclick="removeProfileBlock(${index})">🗑️ Remove</button>
                `;
                
                // Update IDs
                const oldIndex = parseInt(block.id.split('_')[1]);
                const newIndex = index;
                
                if (oldIndex !== newIndex) {
                    block.id = `profile_${newIndex}`;
                    block.querySelector(`#profileId_${oldIndex}`).id = `profileId_${newIndex}`;
                    block.querySelector(`#inputType_${oldIndex}`).id = `inputType_${newIndex}`;
                    block.querySelector(`#outputFilename_${oldIndex}`).id = `outputFilename_${newIndex}`;
                    block.querySelector(`#config_${oldIndex}`).id = `config_${newIndex}`;
                }
            });
            
            // Update templateProfiles array
            templateProfiles = Array.from(remainingBlocks).map((block, index) => ({
                index: index,
                block: block
            }));
        }
        
        function collectTemplateData() {
            const templateName = document.getElementById('templateName').value.trim();
            const templateDescription = document.getElementById('templateDescription').value.trim();
            const templateVersion = document.getElementById('templateVersion').value.trim();
            
            if (!templateName) {
                throw new Error('Template name is required');
            }
            
            const profiles = [];
            const profileBlocks = document.querySelectorAll('.profile-block');
            
            profileBlocks.forEach((block, index) => {
                const profileId = document.getElementById(`profileId_${index}`).value.trim();
                const inputType = document.getElementById(`inputType_${index}`).value;
                const outputFilename = document.getElementById(`outputFilename_${index}`).value.trim();
                const configText = document.getElementById(`config_${index}`).value.trim();
                
                if (!profileId) {
                    throw new Error(`Profile ${index + 1}: Profile ID is required`);
                }
                
                let config;
                try {
                    config = configText ? JSON.parse(configText) : {};
                } catch (e) {
                    throw new Error(`Profile ${index + 1}: Invalid JSON in configuration: ${e.message}`);
                }
                
                const profile = {
                    id_profile: profileId,
                    config: config
                };
                
                if (inputType) profile.input_type = inputType;
                if (outputFilename) profile.output_filename = outputFilename;
                
                profiles.push(profile);
            });
            
            if (profiles.length === 0) {
                throw new Error('At least one profile is required');
            }
            
            return {
                name: templateName,
                description: templateDescription || undefined,
                profiles: profiles
            };
        }
        
        async function validateTemplate() {
            try {
                removeTemplateStatus();
                const templateData = collectTemplateData();
                
                showTemplateStatus('Validating template...', 'warning');
                
                const response = await fetch('/universal-config-templates/validate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(templateData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    if (result.overall_status === 'valid') {
                        showTemplateStatus(`✅ Template is valid! All ${result.valid_profiles} profiles passed validation.`, 'success');
                    } else {
                        let message = `⚠️ Template has issues: ${result.invalid_profiles} of ${result.profiles_validated} profiles are invalid.\n\n`;
                        result.validation_results.forEach(r => {
                            if (r.status === 'invalid') {
                                message += `❌ ${r.id_profile}: ${r.message}\n`;
                            }
                        });
                        showTemplateStatus(message, 'error');
                    }
                } else {
                    showTemplateStatus(`❌ Validation failed: ${result.detail || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                showTemplateStatus(`❌ Validation error: ${error.message}`, 'error');
            }
        }
        
        async function saveTemplate() {
            try {
                removeTemplateStatus();
                const templateData = collectTemplateData();
                
                showTemplateStatus('Saving template...', 'warning');
                
                const response = await fetch('/universal-config-templates', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(templateData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showTemplateStatus(`✅ Template "${result.name}" created successfully! ID: ${result.template_id}`, 'success');
                    
                    // Close modal after 2 seconds
                    setTimeout(() => {
                        closeTemplateModal();
                    }, 2000);
                } else {
                    showTemplateStatus(`❌ Save failed: ${result.detail || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                showTemplateStatus(`❌ Save error: ${error.message}`, 'error');
            }
        }
        
        function showTemplateStatus(message, type) {
            removeTemplateStatus();
            
            const statusDiv = document.createElement('div');
            statusDiv.id = 'templateStatus';
            statusDiv.className = `template-status ${type}`;
            statusDiv.style.whiteSpace = 'pre-wrap';
            statusDiv.textContent = message;
            
            const actionsDiv = document.querySelector('#createTemplateModal .modal-content > div > div:last-child');
            actionsDiv.parentNode.insertBefore(statusDiv, actionsDiv);
        }
        
        function removeTemplateStatus() {
            const existing = document.getElementById('templateStatus');
            if (existing) {
                existing.remove();
            }
        }

        function showError(message) {
            if (!message || message.trim() === '') {
                message = 'Unknown error occurred';
            }
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            
            // Handle multiline messages
            if (message.includes('\n')) {
                errorDiv.innerHTML = message.split('\n').map(line => 
                    line.trim() === '' ? '<br>' : escapeHtml(line)
                ).join('<br>');
            } else {
                errorDiv.textContent = message;
            }
            
            // Add timestamp
            const timestamp = new Date().toLocaleTimeString();
            const timestampSpan = document.createElement('small');
            timestampSpan.style.display = 'block';
            timestampSpan.style.marginTop = '5px';
            timestampSpan.style.opacity = '0.7';
            timestampSpan.textContent = `[${timestamp}]`;
            errorDiv.appendChild(timestampSpan);
            
            document.querySelector('.panel.status-panel').appendChild(errorDiv);
            
            // Remove after 10 seconds for complex errors, 5 seconds for simple ones
            const timeout = message.length > 100 ? 10000 : 5000;
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.remove();
                }
            }, timeout);
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Bulk Selection Functions
        function updateBulkControlsVisibility() {
            const bulkControls = document.getElementById('bulkControls');
            const resultItems = document.querySelectorAll('.result-item');
            bulkControls.style.display = resultItems.length > 0 ? 'block' : 'none';
        }
        
        function updateSelectionCount() {
            const checkboxes = document.querySelectorAll('.result-select');
            const checkedBoxes = document.querySelectorAll('.result-select:checked');
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const selectedCount = document.getElementById('selectedCount');
            const deleteBtn = document.getElementById('deleteSelectedBtn');
            
            selectedCount.textContent = `${checkedBoxes.length} selected`;
            deleteBtn.disabled = checkedBoxes.length === 0;
            
            // Update select all checkbox state
            if (checkedBoxes.length === 0) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = false;
            } else if (checkedBoxes.length === checkboxes.length) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = true;
            } else {
                selectAllCheckbox.indeterminate = true;
            }
        }
        
        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const checkboxes = document.querySelectorAll('.result-select');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
            
            updateSelectionCount();
        }
        
        function clearSelection() {
            const checkboxes = document.querySelectorAll('.result-select');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            updateSelectionCount();
        }
        
        async function deleteSelected() {
            const checkedBoxes = document.querySelectorAll('.result-select:checked');
            const filenames = Array.from(checkedBoxes).map(cb => cb.dataset.filename);
            
            if (filenames.length === 0) return;
            
            if (!confirm(`Are you sure you want to delete ${filenames.length} selected file(s)?`)) return;
            
            let deletedCount = 0;
            let errorCount = 0;
            
            // Show progress
            const deleteBtn = document.getElementById('deleteSelectedBtn');
            const originalText = deleteBtn.textContent;
            deleteBtn.disabled = true;
            
            for (let i = 0; i < filenames.length; i++) {
                const filename = filenames[i];
                deleteBtn.textContent = `🔄 Deleting ${i + 1}/${filenames.length}...`;
                
                try {
                    const response = await fetch(`/api/transcode/output/${filename}`, { method: 'DELETE' });
                    const data = await response.json();
                    
                    if (response.ok) {
                        // Remove from UI
                        const resultItems = document.querySelectorAll('.result-item');
                        resultItems.forEach(item => {
                            if (item.innerHTML.includes(filename)) {
                                item.remove();
                            }
                        });
                        deletedCount++;
                    } else {
                        console.error(`Failed to delete ${filename}:`, data.error);
                        errorCount++;
                    }
                } catch (error) {
                    console.error(`Error deleting ${filename}:`, error);
                    errorCount++;
                }
            }
            
            // Reset button and update UI
            deleteBtn.textContent = originalText;
            deleteBtn.disabled = false;
            updateSelectionCount();
            updateBulkControlsVisibility();
            
            // Show result message
            if (errorCount === 0) {
                console.log(`Successfully deleted ${deletedCount} file(s)`);
            } else {
                console.log(`Deleted ${deletedCount} file(s), ${errorCount} failed`);
            }
        }
    </script>
</body>
</html>