{% extends 'base.html' %}

{% block title %}Dashboard - Media Transcode Service{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Welcome Section -->
    <div class="welcome-section mb-4">
        <h1 class="display-5">Welcome back, <span id="username-display">User</span>!</h1>
        <p class="lead text-muted">Manage your media transcoding jobs and monitor your usage.</p>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4" id="stats-container">
        <div class="col-md-3 mb-3">
            <div class="stat-card card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">Total Jobs</h6>
                            <h2 class="mb-0" id="stat-total-jobs">0</h2>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-briefcase"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="stat-card card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">Processing</h6>
                            <h2 class="mb-0" id="stat-processing">0</h2>
                        </div>
                        <div class="stat-icon text-primary">
                            <i class="fas fa-spinner"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="stat-card card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">Completed</h6>
                            <h2 class="mb-0" id="stat-completed">0</h2>
                        </div>
                        <div class="stat-icon text-success">
                            <i class="fas fa-check-circle"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="stat-card card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">Total Media</h6>
                            <h2 class="mb-0" id="stat-media">0</h2>
                        </div>
                        <div class="stat-icon text-info">
                            <i class="fas fa-photo-video"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex gap-3 flex-wrap">
                        <a href="/jobs/new" class="btn btn-primary">
                            <i class="fas fa-plus me-2"></i>New Job
                        </a>
                        <a href="/jobs" class="btn btn-outline-primary">
                            <i class="fas fa-list me-2"></i>View All Jobs
                        </a>
                        <a href="/configs" class="btn btn-outline-primary">
                            <i class="fas fa-cog me-2"></i>Manage Configs
                        </a>
                        <button class="btn btn-outline-secondary" onclick="refreshDashboard()">
                            <i class="fas fa-sync-alt me-2"></i>Refresh
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Jobs -->
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Recent Jobs</h5>
                        <a href="/jobs" class="btn btn-sm btn-outline-primary">View All</a>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Status</th>
                                    <th>Media Count</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="recent-jobs-list">
                                <tr>
                                    <td colspan="5" class="text-center py-4 text-muted">
                                        <i class="fas fa-spinner fa-spin me-2"></i>Loading...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.dashboard-container {
    max-width: 1400px;
    margin: 0 auto;
}

.stat-card {
    border: none;
    box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    transition: transform 0.2s, box-shadow 0.2s;
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.stat-icon {
    font-size: 2.5rem;
    opacity: 0.8;
}

.welcome-section {
    padding: 2rem 0;
    border-bottom: 1px solid #e9ecef;
}

.gap-3 {
    gap: 1rem!important;
}
</style>
{% endblock %}

{% block js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Check authentication
    const token = localStorage.getItem('token');
    if (!token) {
        window.location.href = '/login';
        return;
    }

    // Load user info
    const user = JSON.parse(localStorage.getItem('user') || '{}');
    document.getElementById('username-display').textContent = user.username || 'User';

    // Load dashboard data
    loadDashboardStats();
    loadRecentJobs();
});

function loadDashboardStats() {
    const token = localStorage.getItem('token');
    
    fetch('/api/jobs/stats', {
        headers: {
            'Authorization': `Bearer ${token}`
        }
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('stat-total-jobs').textContent = data.total_jobs || 0;
        document.getElementById('stat-processing').textContent = data.jobs_by_status?.processing || 0;
        document.getElementById('stat-completed').textContent = data.jobs_by_status?.completed || 0;
        document.getElementById('stat-media').textContent = data.media?.total || 0;
    })
    .catch(error => {
        console.error('Error loading stats:', error);
    });
}

function loadRecentJobs() {
    const token = localStorage.getItem('token');
    
    fetch('/api/jobs?per_page=5', {
        headers: {
            'Authorization': `Bearer ${token}`
        }
    })
    .then(response => response.json())
    .then(data => {
        const tbody = document.getElementById('recent-jobs-list');
        
        if (!data.jobs || data.jobs.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center py-4 text-muted">
                        No jobs found. <a href="/jobs/new">Create your first job</a>
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = data.jobs.map(job => {
            const date = new Date(job.created_at);
            const statusBadge = getStatusBadge(job.status);
            
            return `
                <tr>
                    <td>#${job.id}</td>
                    <td>${statusBadge}</td>
                    <td>${job.media_count || 0}</td>
                    <td>${date.toLocaleDateString()} ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</td>
                    <td>
                        <a href="/jobs/${job.id}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-eye"></i>
                        </a>
                    </td>
                </tr>
            `;
        }).join('');
    })
    .catch(error => {
        console.error('Error loading recent jobs:', error);
        document.getElementById('recent-jobs-list').innerHTML = `
            <tr>
                <td colspan="5" class="text-center py-4 text-danger">
                    Failed to load jobs
                </td>
            </tr>
        `;
    });
}

function getStatusBadge(status) {
    const badges = {
        'pending': '<span class="badge bg-secondary">Pending</span>',
        'processing': '<span class="badge bg-primary">Processing</span>',
        'completed': '<span class="badge bg-success">Completed</span>',
        'failed': '<span class="badge bg-danger">Failed</span>',
        'partial': '<span class="badge bg-warning">Partial</span>'
    };
    return badges[status] || `<span class="badge bg-secondary">${status}</span>`;
}

function refreshDashboard() {
    loadDashboardStats();
    loadRecentJobs();
}
</script>
{% endblock %}