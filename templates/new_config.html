{% extends 'base.html' %}

{% block title %}Configuration Builder - Media Transcode System{% endblock %}

{% block css %}
    <!-- External Libraries -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs/editor/editor.main.css"
          rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tippy.js@6/themes/light.css" rel="stylesheet">

    <!-- Custom Styles -->
    <link rel="stylesheet" href="/static/css/config-builder.css">

{% endblock %}

{% block content %}
    <!-- Page Header with Actions -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="d-flex gap-2">
            <div class="btn-group" role="group">
                <button id="formModeBtn" class="btn btn-outline-primary active">
                    <i class="fas fa-edit"></i> Form Builder
                </button>
                <button id="jsonModeBtn" class="btn btn-outline-primary">
                    <i class="fas fa-code"></i> JSON Editor
                </button>
            </div>
            <button id="loadTemplateBtn" class="btn btn-outline-secondary">
                <i class="fas fa-folder-open"></i> Template
            </button>
            <button id="validateBtn" class="btn btn-outline-info">
                <i class="fas fa-check-circle"></i> Validate
            </button>
            <button id="exportBtn" class="btn btn-outline-success">
                <i class="fas fa-download"></i> Export
            </button>
            <button id="saveBtn" class="btn btn-primary">
                <i class="fas fa-save"></i> Save Config
            </button>
        </div>
    </div>

    <!-- Main Container -->
    <div class="config-container">
        <!-- Sidebar -->
        <aside class="config-sidebar">
            <div class="sidebar-header">
                <h3><i class="fas fa-list"></i> Configuration Sections</h3>
            </div>

            <nav class="config-nav">
                <a href="#basic-info" class="nav-item active" data-section="basic-info">
                    <i class="fas fa-info-circle"></i>
                    <span>Basic Information</span>
                </a>
                <a href="#video-settings" class="nav-item" data-section="video-settings">
                    <i class="fas fa-video"></i>
                    <span>Video Settings</span>
                    <span class="nav-badge" id="video-profiles-count">0</span>
                </a>
                <a href="#image-settings" class="nav-item" data-section="image-settings">
                    <i class="fas fa-image"></i>
                    <span>Image Settings</span>
                    <span class="nav-badge" id="image-profiles-count">0</span>
                </a>
                <a href="#face-detection" class="nav-item" data-section="face-detection">
                    <i class="fas fa-user-friends"></i>
                    <span>Face Detection</span>
                </a>
                <a href="#output-settings" class="nav-item" data-section="output-settings">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <span>Output & Storage</span>
                </a>
            </nav>

            <!-- Config Summary -->
            <div class="config-summary">
                <h4><i class="fas fa-chart-pie"></i> Configuration Summary</h4>
                <div class="summary-stats">
                    <div class="stat-item">
                        <span class="stat-label">Video Profiles:</span>
                        <span class="stat-value" id="summary-video-profiles">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Image Profiles:</span>
                        <span class="stat-value" id="summary-image-profiles">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Face Detection:</span>
                        <span class="stat-value" id="summary-face-detection">Disabled</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Validation Status:</span>
                        <span class="stat-value" id="summary-validation">Not Validated</span>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="config-main">
            <!-- Form Builder Mode -->
            <div id="formBuilderMode" class="config-mode active">
                <!-- Progress Bar -->
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="configProgress"></div>
                    </div>
                    <span class="progress-text" id="progressText">0% Complete</span>
                </div>

                <!-- Configuration Form Sections -->
                <div class="config-sections">

                    <!-- Basic Information Section -->
                    <section id="basic-info-section" class="config-section active">
                        <div class="section-header">
                            <h2><i class="fas fa-info-circle"></i> Basic Information</h2>
                            <p>Define the basic properties and metadata for your configuration profile.</p>
                        </div>

                        <div class="info-card">
                            <!-- Row 1: Config Name vÃ  Description -->
                            <div class="form-grid-2">
                                <div class="form-group">
                                    <label for="configName" class="required">Configuration Name</label>
                                    <input type="text" id="configName" name="config_name" required
                                           data-path="config_name"
                                           placeholder="Config name">
                                </div>

                                <div class="form-group">
                                    <label for="description">Description</label>
                                    <input type="text" id="description" name="description"
                                           data-path="description"
                                           placeholder="Configuration description">
                                </div>
                            </div>

                            <!-- Row 2: Version, Tags, Created At, Updated At -->
                            <div class="form-grid-4">
                                <div class="form-group">
                                    <label for="version">Version</label>
                                    <input type="text" id="version" name="version" value="1.0.0"
                                           data-path="version"
                                           pattern="^\\d+\\.\\d+\\.\\d+$" placeholder="1.0.0">
                                </div>

                                <div class="form-group">
                                    <label for="tags">Tags</label>
                                    <input type="text" id="tags" name="tags"
                                           data-path="tags"
                                           placeholder="tag1, tag2, tag3">
                                </div>

                                <div class="form-group">
                                    <label for="createdAt">Created At</label>
                                    <input type="text" id="createdAt" name="created_at" readonly
                                           data-path="created_at"
                                           placeholder="Auto-generated">
                                </div>

                                <div class="form-group">
                                    <label for="updatedAt">Updated At</label>
                                    <input type="text" id="updatedAt" name="updated_at" readonly
                                           data-path="updated_at"
                                           placeholder="Auto-generated">
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Video Settings Section -->
                    <section id="video-settings-section" class="config-section">
                        <div class="section-header">
                            <h2><i class="fas fa-video"></i> Video Settings</h2>
                            <p>Configure video transcoding profiles, preview generation, and thumbnail settings.</p>
                            <div class="section-controls">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="videoEnabled" checked>
                                    <span class="toggle-slider"></span>
                                    <span class="toggle-label">Enable Video Processing</span>
                                </label>
                            </div>
                        </div>

                        <div class="settings-container" id="videoSettingsContainer">
                            <!-- Video Transcode Profiles -->
                            <div class="settings-group">
                                <div class="group-header">
                                    <h3><i class="fas fa-cog"></i> Transcode Profiles</h3>
                                    <button type="button" class="btn btn-sm btn-primary" id="addVideoProfileBtn">
                                        <i class="fas fa-plus"></i> Add Profile
                                    </button>
                                </div>

                                <div class="profiles-container" id="videoProfilesContainer">
                                    <!-- Video profiles will be dynamically added here -->
                                </div>
                            </div>

                            <!-- Preview Settings -->
                            <div class="settings-group">
                                <div class="group-header">
                                    <h3><i class="fas fa-play-circle"></i> Preview Settings (GIF/Video)</h3>
                                    <button type="button" class="btn btn-sm btn-primary" id="addPreviewProfileBtn">
                                        <i class="fas fa-plus"></i> Add Profile
                                    </button>
                                </div>

                                <div class="profiles-container" id="previewProfilesContainer">
                                    <!-- Preview profiles will be dynamically added here -->
                                </div>
                            </div>

                            <!-- Thumbnail Settings -->
                            <div class="settings-group">
                                <div class="group-header">
                                    <h3><i class="fas fa-image"></i> Thumbnail Settings</h3>
                                    <button type="button" class="btn btn-sm btn-primary" id="addThumbnailProfileBtn">
                                        <i class="fas fa-plus"></i> Add Profile
                                    </button>
                                </div>

                                <div class="profiles-container">
                                    <div class="form-group">
                                        <label for="thumbnailTimestamp">Thumbnail Timestamp (seconds)</label>
                                        <input type="number" id="thumbnailTimestamp" min="0" step="0.1" value="5">
                                        <small class="form-help">Time position to extract thumbnail from video</small>
                                    </div>
                                </div>

                                <div class="profiles-container" id="thumbnailProfilesContainer">
                                    <!-- Thumbnail profiles will be dynamically added here -->
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Image Settings Section -->
                    <section id="image-settings-section" class="config-section">
                        <div class="section-header">
                            <h2><i class="fas fa-image"></i> Image Settings</h2>
                            <p>Configure image processing, format conversion, and thumbnail generation.</p>
                            <div class="section-controls">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="imageEnabled" checked>
                                    <span class="toggle-slider"></span>
                                    <span class="toggle-label">Enable Image Processing</span>
                                </label>
                            </div>
                        </div>

                        <div class="settings-container" id="imageSettingsContainer">
                            <!-- Image Transcode Profiles -->
                            <div class="settings-group">
                                <div class="group-header">
                                    <h3><i class="fas fa-exchange-alt"></i> Transcode Profiles</h3>
                                    <button type="button" class="btn btn-sm btn-primary" id="addImageProfileBtn">
                                        <i class="fas fa-plus"></i> Add Profile
                                    </button>
                                </div>

                                <div class="profiles-container" id="imageProfilesContainer">
                                    <!-- Image profiles will be dynamically added here -->
                                </div>
                            </div>

                            <!-- Image Thumbnail Profiles -->
                            <div class="settings-group">
                                <div class="group-header">
                                    <h3><i class="fas fa-images"></i> Thumbnail Profiles</h3>
                                    <button type="button" class="btn btn-sm btn-primary" id="addImageThumbnailBtn">
                                        <i class="fas fa-plus"></i> Add Thumbnail Profile
                                    </button>
                                </div>

                                <div class="profiles-container" id="imageThumbnailContainer">
                                    <!-- Image thumbnail profiles will be dynamically added here -->
                                </div>
                            </div>

                        </div>
                    </section>

                    <!-- Face Detection Section -->
                    <section id="face-detection-section" class="config-section">
                        <div class="section-header">
                            <h2><i class="fas fa-user-friends"></i> Face Detection</h2>
                            <p>Configure AI-powered face detection, recognition, and analysis features.</p>
                            <div class="section-controls">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="faceDetectionEnabled">
                                    <span class="toggle-slider"></span>
                                    <span class="toggle-label">Enable Face Detection</span>
                                </label>
                            </div>
                        </div>

                        <div class="settings-container" id="faceDetectionContainer" style="display: none;">
                            <!-- Face detection settings will be dynamically populated -->
                        </div>
                    </section>

                    <!-- Output Settings Section -->
                    <section id="output-settings-section" class="config-section">
                        <div class="section-header">
                            <h2><i class="fas fa-cloud-upload-alt"></i> Output & Storage Settings</h2>
                            <p>Configure storage destinations, file naming, and delivery options.</p>
                        </div>

                        <div class="settings-container">
                            <!-- Storage settings will be dynamically populated -->
                        </div>
                    </section>

                </div>

                <!-- Form Navigation -->
                <div class="form-navigation">
                    <button type="button" id="prevSectionBtn" class="btn btn-secondary" disabled>
                        <i class="fas fa-chevron-left"></i> Previous
                    </button>
                    <button type="button" id="nextSectionBtn" class="btn btn-primary">
                        Next <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>

            <!-- JSON Editor Mode -->
            <div id="jsonEditorMode" class="config-mode">
                <div class="editor-container">
                    <div class="editor-header">
                        <h3><i class="fas fa-code"></i> JSON Configuration Editor</h3>
                        <div class="editor-actions">
                            <button id="formatJsonBtn" class="btn btn-sm btn-secondary">
                                <i class="fas fa-magic"></i> Format
                            </button>
                            <button id="validateJsonBtn" class="btn btn-sm btn-info">
                                <i class="fas fa-check"></i> Validate
                            </button>
                            <button id="syncFromFormBtn" class="btn btn-sm btn-warning">
                                <i class="fas fa-sync"></i> Sync from Form
                            </button>
                        </div>
                    </div>

                    <div id="jsonEditor" class="json-editor"></div>

                    <div class="editor-status">
                        <div class="status-info">
                            <span id="jsonStatus" class="status-indicator">Ready</span>
                            <span id="jsonLineCount" class="line-count">Lines: 0</span>
                        </div>
                        <div class="validation-result" id="validationResult"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Validation Panel -->
    <div id="validationPanel" class="validation-panel">
        <div class="panel-header">
            <h4><i class="fas fa-check-circle"></i> Validation Results</h4>
            <button id="closeValidationBtn" class="btn-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="panel-content" id="validationContent">
            <!-- Validation results will be displayed here -->
        </div>
    </div>

    <!-- Template Library Modal -->
    <div id="templateModal" class="modal" style="display: none;">
        <div class="modal-overlay" id="templateModalOverlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-folder-open"></i> Template Library</h3>
                <button class="modal-close" id="closeTemplateModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="template-grid" id="templateGrid">
                    <!-- Templates will be dynamically loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p id="loadingText">Processing...</p>
        </div>
    </div>

{% endblock %}

{% block js %}
    <!-- Pass config_id to JavaScript if editing -->
<script>
    window.CONFIG_ID = {{ config_id|tojson if config_id else 'null' }};
</script>

    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs/loader.js"></script>
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>

    <!-- Custom Scripts -->
    <script src="/static/js/config-builder.js"></script>
{% endblock %}