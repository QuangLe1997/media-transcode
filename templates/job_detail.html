{% extends 'base.html' %}

{% block title %}Job Details - Media Transcode Service{% endblock %}

{% block content %}
    <div class="job-detail-header d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="mb-1">Job <span id="job-id-display">#</span></h1>
            <div class="d-flex align-items-center gap-3">
                <span id="job-status-badge"></span>
                <small class="text-muted">Created: <span id="job-created-date"></span></small>
            </div>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-primary" onclick="refreshJob()">
                <i class="fas fa-sync-alt"></i>
            </button>
            <button class="btn btn-outline-danger" id="delete-job-btn" onclick="deleteCurrentJob()">
                <i class="fas fa-trash"></i>
            </button>
            <a href="/jobs" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>Back
            </a>
        </div>
</div>

    <!-- Loading State -->
    <div id="loading-container" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- Job Content -->
    <div id="job-content" style="display: none;">
        <!-- Job Info Card -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Job Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <label class="text-muted small">Status</label>
                                <p class="mb-0" id="job-status-text"></p>
                            </div>
                            <div class="col-md-3">
                                <label class="text-muted small">Config</label>
                                <p class="mb-0" id="job-config"></p>
                            </div>
                            <div class="col-md-3">
                                <label class="text-muted small">Total Media</label>
                                <p class="mb-0" id="job-media-count">0</p>
                            </div>
                            <div class="col-md-3">
                                <label class="text-muted small">Last Updated</label>
                                <p class="mb-0" id="job-updated"></p>
                            </div>
                    </div>
                    </div>
                    <div class="card-footer" id="job-actions">
                        <!-- Dynamic actions will be added here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Progress Overview -->
        <div class="row mb-4" id="progress-overview" style="display: none;">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Processing Progress</h5>
                    </div>
                    <div class="card-body">
                        <div class="progress" style="height: 25px;">
                            <div class="progress-bar bg-success" id="progress-completed" style="width: 0%">
                                <span class="progress-label"></span>
                            </div>
                            <div class="progress-bar bg-primary progress-bar-striped progress-bar-animated"
                                 id="progress-processing" style="width: 0%">
                                <span class="progress-label"></span>
                            </div>
                            <div class="progress-bar bg-warning" id="progress-pending" style="width: 0%">
                                <span class="progress-label"></span>
                            </div>
                            <div class="progress-bar bg-danger" id="progress-failed" style="width: 0%">
                                <span class="progress-label"></span>
                            </div>
                        </div>
                        <div class="mt-3 d-flex justify-content-around text-center">
                            <div>
                                <small class="text-muted">Completed</small>
                                <p class="mb-0 fw-bold text-success" id="stat-completed">0</p>
                            </div>
                            <div>
                                <small class="text-muted">Processing</small>
                                <p class="mb-0 fw-bold text-primary" id="stat-processing">0</p>
                            </div>
                            <div>
                                <small class="text-muted">Pending</small>
                                <p class="mb-0 fw-bold text-warning" id="stat-pending">0</p>
                            </div>
                            <div>
                                <small class="text-muted">Failed</small>
                                <p class="mb-0 fw-bold text-danger" id="stat-failed">0</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Media Items -->
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Media Files</h5>
                    </div>
                    <div class="card-body p-2">
                        <div id="media-container" class="media-grid">
                            <!-- Media items will be added here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Media Detail Modal -->
    <div class="modal fade" id="mediaDetailModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Media Analysis</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="media-detail-content">
                    <!-- Media details will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <style>
        .job-detail-header {
            padding-bottom: 1rem;
            border-bottom: 1px solid #e9ecef;
        }

        .media-grid {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .media-item-card {
            border: 1px solid #e9ecef;
            border-radius: 0.375rem;
            padding: 0.75rem;
            background: white;
            transition: all 0.2s;
            width: 100%;
            display: flex;
            flex-direction: column;
        }

        .media-item-card:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }

        .media-header {
            margin-bottom: 0.5rem;
            flex-shrink: 0;
        }

        .media-icon {
            font-size: 1.5rem;
            opacity: 0.6;
        }

        .task-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.75rem;
            margin-top: 1rem;
        }

        @media (max-width: 768px) {
            .task-grid {
                grid-template-columns: 1fr 1fr;
                gap: 0.5rem;
            }
        }

        @media (max-width: 576px) {
            .task-grid {
                grid-template-columns: 1fr;
            }
        }

        .task-card {
            border: 1px solid #e9ecef;
            border-radius: 0.25rem;
            padding: 0.5rem;
            background: #f8f9fa;
            font-size: 0.875rem;
        }

        .task-card.completed {
            background: #d4edda;
            border-color: #c3e6cb;
        }

        .task-card.failed {
            background: #f8d7da;
            border-color: #f5c6cb;
        }

        .task-card.processing {
            background: #cce5ff;
            border-color: #b8daff;
        }

        .output-preview-container {
            width: 80px;
            height: 60px;
        }

        .output-preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 0.25rem;
            border: 1px solid #dee2e6;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .output-preview:hover {
            transform: scale(1.05);
        }

        .progress-label {
            font-size: 0.875rem;
            font-weight: 500;
        }

        .media-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .media-icon {
            font-size: 3rem;
            opacity: 0.3;
        }

        .face-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 0.5rem;
        }

        .face-card {
            border: 1px solid #e9ecef;
            border-radius: 0.375rem;
            padding: 0.5rem;
            text-align: center;
            background: white;
        }

        .face-avatar {
            width: 100%;
            height: auto;
            border-radius: 0.25rem;
        }
    </style>
{% endblock %}

{% block js %}
    <script>
        let currentJobId = null;
        let refreshInterval = null;

        document.addEventListener('DOMContentLoaded', function () {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/login';
                return;
            }

            // Get job ID from URL
            const path = window.location.pathname;
            currentJobId = path.split('/').pop();

            // Load job details
            loadJobDetails();

            // Set up auto-refresh for processing jobs
            refreshInterval = setInterval(() => {
                const status = document.getElementById('job-status-text')?.textContent?.toLowerCase();
                if (status === 'processing') {
                    loadJobDetails(true); // Silent refresh
                }
            }, 5000);
        });

        // Clean up interval when leaving page
        window.addEventListener('beforeunload', function () {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        });

        function loadJobDetails(silent = false) {
            const token = localStorage.getItem('token');

            if (!silent) {
                document.getElementById('loading-container').style.display = 'block';
                document.getElementById('job-content').style.display = 'none';
            }

            fetch(`/api/jobs/${currentJobId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
                .then(response => {
                    if (!response.ok) throw new Error('Failed to load job');
                    return response.json();
                })
                .then(job => {
                    renderJobDetails(job);
                    document.getElementById('loading-container').style.display = 'none';
                    document.getElementById('job-content').style.display = 'block';
                })
                .catch(error => {
                    console.error('Error loading job:', error);
                    if (!silent) {
                        alert('Failed to load job details');
                        window.location.href = '/jobs';
                    }
                });
        }

        function renderJobDetails(job) {
            // Update header
            document.getElementById('job-id-display').textContent = `#${job.id}`;
            document.getElementById('job-status-badge').innerHTML = getStatusBadge(job.status);
            document.getElementById('job-created-date').textContent = new Date(job.created_at).toLocaleString();

            // Update info
            document.getElementById('job-status-text').innerHTML = getStatusBadge(job.status);
            document.getElementById('job-config').textContent = `Config #${job.config_id}`;
            document.getElementById('job-media-count').textContent = job.media?.length || 0;
            document.getElementById('job-updated').textContent = new Date(job.updated_at).toLocaleString();

            // Update actions based on status
            const actionsContainer = document.getElementById('job-actions');
            actionsContainer.innerHTML = '';

            if (job.status === 'pending' || job.status === 'created') {
                actionsContainer.innerHTML = `
            <button class="btn btn-primary" onclick="processJob()">
                <i class="fas fa-play me-2"></i>Start Processing
            </button>
        `;
            } else if (job.status === 'failed' || job.status === 'partial') {
                actionsContainer.innerHTML = `
            <button class="btn btn-warning" onclick="retryJob()">
                <i class="fas fa-redo me-2"></i>Retry Failed Tasks
            </button>
        `;
            }

            // Calculate progress stats
            if (job.media && job.media.length > 0) {
                const stats = calculateJobStats(job.media);

                if (stats.total > 0) {
                    document.getElementById('progress-overview').style.display = 'block';

                    // Update progress bars
                    updateProgressBar('completed', stats.completed, stats.total);
                    updateProgressBar('processing', stats.processing, stats.total);
                    updateProgressBar('pending', stats.pending, stats.total);
                    updateProgressBar('failed', stats.failed, stats.total);

                    // Update stats
                    document.getElementById('stat-completed').textContent = stats.completed;
                    document.getElementById('stat-processing').textContent = stats.processing;
                    document.getElementById('stat-pending').textContent = stats.pending;
                    document.getElementById('stat-failed').textContent = stats.failed;
                }
            }

            // Render media
            renderMediaItems(job.media || []);
        }

        function calculateJobStats(media) {
            let stats = {
                total: 0,
                pending: 0,
                processing: 0,
                completed: 0,
                failed: 0
            };

            media.forEach(m => {
                if (m.tasks) {
                    m.tasks.forEach(task => {
                        stats.total++;
                        stats[task.status]++;
                    });
                }
            });

            return stats;
        }

        function updateProgressBar(status, count, total) {
            const percentage = total > 0 ? (count / total * 100).toFixed(1) : 0;
            const bar = document.getElementById(`progress-${status}`);
            bar.style.width = `${percentage}%`;

            const label = bar.querySelector('.progress-label');
            if (count > 0) {
                label.textContent = `${count}`;
            }
        }

        function renderMediaItems(media) {
            const container = document.getElementById('media-container');

            if (media.length === 0) {
                container.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-film fa-4x text-muted mb-3"></i>
                <p class="text-muted">No media files in this job</p>
            </div>
        `;
                return;
            }

            container.innerHTML = media.map(m => `
        <div class="media-item-card">
            <div class="media-header">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="d-flex align-items-start">
                        <i class="fas fa-${m.file_type === 'video' ? 'film' : 'image'} text-${m.file_type === 'video' ? 'primary' : 'success'} me-3 media-icon"></i>
                        <div>
                            <h6 class="mb-1">${m.original_filename}</h6>
                            <div class="d-flex gap-3 text-muted">
                                <small>${m.width}×${m.height}</small>
                                <small>${formatFileSize(m.file_size)}</small>
                                ${m.duration ? `<small>${formatDuration(m.duration)}</small>` : ''}
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-outline-primary btn-sm" onclick="analyzeMedia(${m.id})">
                        <i class="fas fa-chart-line me-1"></i>Analyze
                    </button>
                </div>
            </div>
            
            <div class="task-grid">
                ${m.tasks ? m.tasks.map(task => renderTaskCard(task)).join('') : '<small class="text-muted">No tasks</small>'}
            </div>
        </div>
    `).join('');
        }

        function renderTaskCard(task) {
            const statusClass = task.status === 'completed' ? 'completed' :
                task.status === 'failed' ? 'failed' :
                    task.status === 'processing' ? 'processing' : '';

            const icon = task.task_type === 'transcode' ? 'fa-exchange-alt' :
                task.task_type === 'thumbnail' ? 'fa-image' :
                    task.task_type === 'preview' ? 'fa-play-circle' :
                        task.task_type === 'face_detection' ? 'fa-user-circle' : 'fa-cog';

            return `
        <div class="task-card ${statusClass}">
            <div class="d-flex justify-content-between align-items-center mb-1">
                <div class="d-flex align-items-center">
                    <i class="fas ${icon} me-1"></i>
                    <small class="fw-bold">${formatTaskType(task.task_type)}</small>
                </div>
                ${getStatusBadge(task.status, 'small')}
            </div>
            <small class="text-muted d-block text-truncate" title="${task.profile_name}">${task.profile_name}</small>
            ${task.error_message ? `<div class="alert alert-danger mt-1 mb-0 p-1"><small>${task.error_message.substring(0, 50)}...</small></div>` : ''}
            ${task.outputs && task.outputs.length > 0 ? renderTaskOutputs(task) : ''}
        </div>
    `;
        }

        function renderTaskOutputs(task) {
            if (!task.outputs || task.outputs.length === 0) return '';

            const output = task.outputs[0]; // Single output per task

            if (task.task_type === 'face_detection') {
                return `<div class="mt-1">
            <button class="btn btn-sm btn-outline-primary w-100" onclick="viewFaceResults('${output.s3_url}')">
                <i class="fas fa-users me-1"></i><small>Faces</small>
            </button>
        </div>`;
            }

            const isImage = ['jpg', 'jpeg', 'png', 'webp', 'gif'].includes(output.format?.toLowerCase());
            const isVideo = ['mp4', 'webm', 'mov'].includes(output.format?.toLowerCase());

            if (isImage || task.task_type === 'thumbnail') {
                return `
            <div class="output-preview-container mt-1">
                <img src="${output.s3_url}" class="output-preview" onclick="window.open('${output.s3_url}', '_blank')" title="${output.output_filename}">
            </div>
        `;
            } else if (isVideo) {
                return `
            <div class="output-preview-container mt-1">
                <video src="${output.s3_url}" class="output-preview" onclick="window.open('${output.s3_url}', '_blank')" title="${output.output_filename}"></video>
            </div>
        `;
            }

            return `<small class="text-muted mt-1 d-block">${output.output_filename}</small>`;
        }

        function analyzeMedia(mediaId) {
            const token = localStorage.getItem('token');
            const modal = new bootstrap.Modal(document.getElementById('mediaDetailModal'));
            const content = document.getElementById('media-detail-content');

            content.innerHTML = '<div class="text-center"><div class="spinner-border text-primary"></div></div>';
            modal.show();

            fetch(`/api/media/${mediaId}/analyze`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
                .then(response => response.json())
                .then(data => {
                    content.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <h6>Media Information</h6>
                    <table class="table table-sm">
                        <tr><td>Filename:</td><td>${data.media.original_filename}</td></tr>
                        <tr><td>Type:</td><td>${data.media.file_type}</td></tr>
                        <tr><td>Size:</td><td>${formatFileSize(data.media.file_size)}</td></tr>
                        <tr><td>Dimensions:</td><td>${data.media.width}x${data.media.height}</td></tr>
                        ${data.media.duration ? `<tr><td>Duration:</td><td>${formatDuration(data.media.duration)}</td></tr>` : ''}
                    </table>
                </div>
                <div class="col-md-6">
                    <h6>Processing Status</h6>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span>Total Tasks</span>
                            <strong>${data.tasks.total}</strong>
                        </div>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar bg-success" style="width: ${(data.tasks.completed / data.tasks.total * 100) || 0}%"></div>
                            <div class="progress-bar bg-primary" style="width: ${(data.tasks.processing / data.tasks.total * 100) || 0}%"></div>
                            <div class="progress-bar bg-warning" style="width: ${(data.tasks.pending / data.tasks.total * 100) || 0}%"></div>
                            <div class="progress-bar bg-danger" style="width: ${(data.tasks.failed / data.tasks.total * 100) || 0}%"></div>
                        </div>
                    </div>
                </div>
            </div>
            ${data.analysis ? `
                <div class="mt-3">
                    <h6>Technical Details</h6>
                    <pre class="bg-light p-3 rounded">${JSON.stringify(data.analysis, null, 2)}</pre>
                </div>
            ` : ''}
        `;
                })
                .catch(error => {
                    content.innerHTML = '<div class="alert alert-danger">Failed to load analysis</div>';
                });
        }

        function viewFaceResults(url) {
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    const modal = new bootstrap.Modal(document.getElementById('mediaDetailModal'));
                    const content = document.getElementById('media-detail-content');

                    if (data.faces && data.faces.length > 0) {
                        content.innerHTML = `
                    <h6>Detected ${data.faces.length} Face${data.faces.length > 1 ? 's' : ''}</h6>
                    <div class="face-gallery mt-3">
                        ${data.faces.map(face => `
                            <div class="face-card">
                                <img src="data:image/jpeg;base64,${face.avatar}" class="face-avatar">
                                <small class="d-block mt-1">
                                    ${face.gender !== undefined ? (face.gender === 1 ? '♂' : '♀') : ''}
                                    ${face.age !== undefined ? `Age ${face.age}` : ''}
                                </small>
                            </div>
                        `).join('')}
                    </div>
                `;
                    } else {
                        content.innerHTML = '<div class="alert alert-info">No faces detected</div>';
                    }

                    modal.show();
                })
                .catch(error => {
                    alert('Failed to load face detection results');
                });
        }

        function processJob() {
            const token = localStorage.getItem('token');

            fetch(`/api/jobs/${currentJobId}/process`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
                .then(response => {
                    if (!response.ok) throw new Error('Failed to start processing');
                    return response.json();
                })
                .then(data => {
                    alert('Job processing started!');
                    loadJobDetails();
                })
                .catch(error => {
                    alert('Failed to start processing: ' + error.message);
                });
        }

        function retryJob() {
            const token = localStorage.getItem('token');

            fetch(`/api/jobs/${currentJobId}/retry`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
        }
            })
                .then(response => {
                    if (!response.ok) throw new Error('Failed to retry job');
                    return response.json();
                })
                .then(data => {
                    alert('Job retry started!');
                    loadJobDetails();
                })
                .catch(error => {
                    alert('Failed to retry job: ' + error.message);
                });
        }

        function deleteCurrentJob() {
            if (!confirm('Are you sure you want to delete this job? This action cannot be undone.')) {
                return;
    }

            const token = localStorage.getItem('token');

            fetch(`/api/jobs/${currentJobId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
                .then(response => {
                    if (!response.ok) throw new Error('Failed to delete job');
                    return response.json();
                })
                .then(data => {
                    window.location.href = '/jobs';
                })
                .catch(error => {
                    alert('Failed to delete job: ' + error.message);
                });
        }

        function refreshJob() {
            loadJobDetails();
        }

        function getStatusBadge(status, size = '') {
            const sizeClass = size === 'small' ? 'badge-sm' : '';
            const badges = {
                'pending': `<span class="badge bg-secondary ${sizeClass}">Pending</span>`,
                'processing': `<span class="badge bg-primary ${sizeClass}">Processing</span>`,
                'completed': `<span class="badge bg-success ${sizeClass}">Completed</span>`,
                'failed': `<span class="badge bg-danger ${sizeClass}">Failed</span>`,
                'partial': `<span class="badge bg-warning ${sizeClass}">Partial</span>`
            };
            return badges[status] || `<span class="badge bg-secondary ${sizeClass}">${status}</span>`;
        }

        function formatTaskType(type) {
            const types = {
                'transcode': 'Transcode',
                'thumbnail': 'Thumbnail',
                'preview': 'Preview',
                'face_detection': 'Face Detection'
            };
            return types[type] || type;
        }

        function formatFileSize(bytes) {
            if (!bytes) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatDuration(seconds) {
            if (!seconds) return '0:00';
            const hrs = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);

            if (hrs > 0) {
                return `${hrs}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }
</script>
{% endblock %}