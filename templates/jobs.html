{% extends 'base.html' %}

{% block title %}Jobs - Media Transcode Service{% endblock %}

{% block content %}
    <div class="jobs-header d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="mb-1">Your Jobs</h1>
            <p class="text-muted mb-0">Manage and monitor your media transcoding jobs</p>
        </div>
    <a href="/jobs/new" class="btn btn-primary">
        <i class="fas fa-plus me-2"></i>New Job
    </a>
</div>

    <!-- Filter Bar -->
    <div class="filter-bar card mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label small text-muted">Status</label>
                    <select class="form-select" id="filter-status">
                        <option value="">All Statuses</option>
                        <option value="pending">Pending</option>
                        <option value="processing">Processing</option>
                        <option value="completed">Completed</option>
                        <option value="failed">Failed</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label small text-muted">Date From</label>
                    <input type="date" class="form-control" id="filter-date-from">
                </div>
                <div class="col-md-3">
                    <label class="form-label small text-muted">Date To</label>
                    <input type="date" class="form-control" id="filter-date-to">
                </div>
                <div class="col-md-3">
                    <label class="form-label small text-muted">&nbsp;</label>
                    <div class="d-flex gap-2">
                        <button class="btn btn-primary flex-fill" onclick="applyFilters()">
                            <i class="fas fa-filter me-2"></i>Filter
                        </button>
                        <button class="btn btn-outline-secondary" onclick="clearFilters()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

<div id="jobs-container">
    <div class="d-flex justify-content-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
</div>

<!-- Job List Template -->
<template id="jobs-template">
    <div class="card mb-4">
        <div class="card-header bg-light">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h5 class="mb-0">Jobs</h5>
                </div>
                <div class="col-md-6">
                    <div class="input-group">
                        <input type="text" class="form-control" id="job-search" placeholder="Search jobs...">
                        <button class="btn btn-outline-secondary" type="button" id="refresh-jobs">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Created</th>
                            <th>Status</th>
                            <th>Media</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="jobs-list">
                        <!-- Jobs will be added here dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</template>

<!-- No Jobs Template -->
<template id="no-jobs-template">
    <div class="card">
        <div class="card-body text-center py-5">
            <i class="fas fa-inbox fa-4x mb-3 text-secondary"></i>
            <h3>No Jobs Found</h3>
            <p class="mb-4">You haven't created any jobs yet.</p>
            <a href="/jobs/new" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>Create Your First Job
            </a>
        </div>
    </div>
</template>

<!-- Job Row Template -->
<template id="job-row-template">
    <tr>
        <td class="job-id"></td>
        <td class="job-created"></td>
        <td class="job-status"></td>
        <td class="job-media-count"></td>
        <td>
            <div class="btn-group btn-group-sm">
                <a href="#" class="btn btn-outline-primary view-job">
                    <i class="fas fa-eye"></i>
                </a>
                <button type="button" class="btn btn-outline-danger delete-job">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </div>
        </td>
    </tr>
</template>
{% endblock %}

{% block js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Check if user is authenticated
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '/login';
            return;
        }

        // Load jobs
        loadJobs();

        // Add event listener for refresh button
        document.addEventListener('click', function(e) {
            if (e.target.id === 'refresh-jobs' || e.target.closest('#refresh-jobs')) {
                loadJobs();
            }
        });

        // Add event listener for search input
        document.addEventListener('input', function(e) {
            if (e.target.id === 'job-search') {
                const searchValue = e.target.value.toLowerCase();
                const jobRows = document.querySelectorAll('#jobs-list tr');

                jobRows.forEach(row => {
                    const jobId = row.querySelector('.job-id').textContent.toLowerCase();
                    const jobStatus = row.querySelector('.job-status').textContent.toLowerCase();

                    if (jobId.includes(searchValue) || jobStatus.includes(searchValue)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            }
        });

        // Add event listener for view and delete buttons
        document.addEventListener('click', function(e) {
            // View job
            if (e.target.classList.contains('view-job') || e.target.closest('.view-job')) {
                e.preventDefault();
                const row = e.target.closest('tr');
                const jobId = row.querySelector('.job-id').textContent;
                window.location.href = `/jobs/${jobId}`;
            }

            // Delete job
            if (e.target.classList.contains('delete-job') || e.target.closest('.delete-job')) {
                e.preventDefault();
                const row = e.target.closest('tr');
                const jobId = row.querySelector('.job-id').textContent;

                if (confirm(`Are you sure you want to delete job #${jobId}?`)) {
                    deleteJob(jobId);
                }
            }
        });
    });

    /**
     * Load jobs from API
     */
    function loadJobs(filters = {}) {
        const jobsContainer = document.getElementById('jobs-container');
        jobsContainer.innerHTML = `
            <div class="d-flex justify-content-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        `;

        const token = localStorage.getItem('token');

        // Build query params
        const params = new URLSearchParams();
        if (filters.status) params.append('status', filters.status);
        if (filters.date_from) params.append('date_from', filters.date_from);
        if (filters.date_to) params.append('date_to', filters.date_to);

        const url = params.toString() ? `/api/jobs/search?${params}` : '/api/jobs';

        fetch(url, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to load jobs');
            }
            return response.json();
        })
        .then(data => {
            renderJobs(data.jobs || []);
        })
        .catch(error => {
            console.error('Error loading jobs:', error);
            jobsContainer.innerHTML = `
                <div class="alert alert-danger">
                    Failed to load jobs. Please try again.
                </div>
            `;
        });
    }

    /**
     * Render jobs
     */
    function renderJobs(jobs) {
        const jobsContainer = document.getElementById('jobs-container');

        if (jobs.length === 0) {
            // No jobs
            const template = document.getElementById('no-jobs-template');
            const content = template.content.cloneNode(true);
            jobsContainer.innerHTML = '';
            jobsContainer.appendChild(content);
            return;
        }

        // Has jobs
        const template = document.getElementById('jobs-template');
        const content = template.content.cloneNode(true);
        jobsContainer.innerHTML = '';
        jobsContainer.appendChild(content);

        const jobsList = document.getElementById('jobs-list');

        // Sort jobs by creation date (newest first)
        jobs.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

        // Add each job
        jobs.forEach(job => {
            const template = document.getElementById('job-row-template');
            const row = template.content.cloneNode(true);

            row.querySelector('.job-id').textContent = job.id;

            const createdDate = new Date(job.created_at);
            row.querySelector('.job-created').textContent = createdDate.toLocaleDateString() + ' ' +
                                                         createdDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

            const statusCell = row.querySelector('.job-status');
            let statusBadge = '';

            switch (job.status) {
                case 'pending':
                    statusBadge = '<span class="badge bg-secondary">Pending</span>';
                    break;
                case 'processing':
                    statusBadge = '<span class="badge bg-primary">Processing</span>';
                    break;
                case 'completed':
                    statusBadge = '<span class="badge bg-success">Completed</span>';
                    break;
                case 'failed':
                    statusBadge = '<span class="badge bg-danger">Failed</span>';
                    break;
                case 'partial':
                    statusBadge = '<span class="badge bg-warning">Partial</span>';
                    break;
                default:
                    statusBadge = `<span class="badge bg-secondary">${job.status}</span>`;
            }

            statusCell.innerHTML = statusBadge;
            row.querySelector('.job-media-count').textContent = job.media_count || 0;

            jobsList.appendChild(row);
        });
    }

    /**
     * Delete a job
     */
    function deleteJob(jobId) {
        const token = localStorage.getItem('token');

        fetch(`/api/jobs/${jobId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to delete job');
            }
            return response.json();
        })
        .then(data => {
            // Reload jobs
            loadJobs();
        })
        .catch(error => {
            console.error('Error deleting job:', error);
            alert('Failed to delete job. Please try again.');
        });
    }

    /**
     * Apply filters
     */
    function applyFilters() {
        const filters = {
            status: document.getElementById('filter-status').value,
            date_from: document.getElementById('filter-date-from').value,
            date_to: document.getElementById('filter-date-to').value
        };

        loadJobs(filters);
    }

    /**
     * Clear filters
     */
    function clearFilters() {
        document.getElementById('filter-status').value = '';
        document.getElementById('filter-date-from').value = '';
        document.getElementById('filter-date-to').value = '';
        loadJobs();
    }
</script>
{% endblock %}