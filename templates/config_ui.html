{% extends 'base.html' %}

{% block title %}Media Transcode Configuration Editor{% endblock %}

{% block content %}
    <body>
    <div class="loading">
        <div class="loading-spinner"></div>
    </div>

    <div class="container">
        <div class="header">
            <h1>Media Transcode Configuration Editor</h1>
            <div class="header-actions">
                <button id="load-config" class="btn btn-secondary">Load Config</button>
                <button id="save-config" class="btn btn-success">Save Config</button>
            </div>
        </div>

        <div class="alert alert-info">
            Select a configuration template to get started or create a new custom configuration.
        </div>

        <div class="config-templates">
            <div class="config-template" data-template="high-quality">
                <h3>High Quality</h3>
                <p>Configuration for high-quality video and image processing</p>
                <div class="badges">
                    <span class="badge badge-primary">Video</span>
                    <span class="badge badge-primary">Image</span>
                    <span class="badge badge-success">Face Detection</span>
                </div>
            </div>
            <div class="config-template" data-template="standard">
                <h3>Standard</h3>
                <p>Standard configuration for video and image transcoding</p>
                <div class="badges">
                    <span class="badge badge-primary">Video</span>
                    <span class="badge badge-primary">Image</span>
                    <span class="badge badge-success">Face Detection</span>
                </div>
            </div>
            <div class="config-template" data-template="minimal">
                <h3>Minimal</h3>
                <p>Minimal configuration for basic transcoding needs</p>
                <div class="badges">
                    <span class="badge badge-primary">Video</span>
                    <span class="badge badge-primary">Image</span>
                </div>
            </div>
            <div class="config-template" data-template="video-only">
                <h3>Video Only</h3>
                <p>Configuration dedicated to video transcoding</p>
                <div class="badges">
                    <span class="badge badge-primary">Video</span>
                    <span class="badge badge-success">Face Detection</span>
                </div>
            </div>
            <div class="config-template" data-template="image-only">
                <h3>Image Only</h3>
                <p>Configuration dedicated to image processing</p>
                <div class="badges">
                    <span class="badge badge-primary">Image</span>
                    <span class="badge badge-success">Face Detection</span>
                </div>
            </div>
            <div class="config-template" data-template="custom">
                <h3>Custom</h3>
                <p>Create a fully customized configuration</p>
                <div class="badges">
                    <span class="badge badge-info">Custom</span>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <span>Basic Configuration</span>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label for="config-name">Configuration Name</label>
                    <input type="text" id="config-name" placeholder="Enter a name for this configuration">
                </div>
                <div class="form-group">
                    <label for="config-description">Description</label>
                    <textarea id="config-description"
                              placeholder="Enter a description for this configuration"></textarea>
                </div>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" data-tab="video-settings">Video Settings</div>
            <div class="tab" data-tab="image-settings">Image Settings</div>
            <div class="tab" data-tab="face-detection">Face Detection</div>
            <div class="tab" data-tab="output-settings">Output Settings</div>
            <div class="tab" data-tab="json-preview">JSON Preview</div>
        </div>

        <div class="tab-content active" id="video-settings">
            <div class="card">
                <div class="card-header">
                    <span>Video Transcode Profiles</span>
                    <button id="add-video-profile" class="btn btn-primary btn-sm">Add Profile</button>
                </div>
                <div class="card-body">
                    <div class="toggle-container">
                        <label class="toggle">
                            <input type="checkbox" id="enable-video-settings" checked>
                            <span class="slider"></span>
                        </label>
                        <span>Enable Video Settings</span>
                    </div>
                    <div id="video-profiles-container" class="profile-list"></div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <span>Video Preview Settings</span>
                    <button id="add-preview-profile" class="btn btn-primary btn-sm">Add Profile</button>
                </div>
                <div class="card-body">
                    <div id="preview-profiles-container" class="profile-list"></div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <span>Video Thumbnail Settings</span>
                    <button id="add-video-thumbnail-profile" class="btn btn-primary btn-sm">Add Profile</button>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label for="thumbnail-timestamp">Thumbnail Timestamp (seconds)</label>
                        <input type="number" id="thumbnail-timestamp" min="0" value="5">
                    </div>
                    <div id="video-thumbnail-profiles-container" class="profile-list"></div>
                </div>
            </div>
        </div>

        <div class="tab-content" id="image-settings">
            <div class="card">
                <div class="card-header">
                    <span>Image Transcode Profiles</span>
                    <button id="add-image-profile" class="btn btn-primary btn-sm">Add Profile</button>
                </div>
                <div class="card-body">
                    <div class="toggle-container">
                        <label class="toggle">
                            <input type="checkbox" id="enable-image-settings" checked>
                            <span class="slider"></span>
                        </label>
                        <span>Enable Image Settings</span>
                    </div>
                    <div id="image-profiles-container" class="profile-list"></div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <span>Image Thumbnail Profiles</span>
                    <button id="add-image-thumbnail-profile" class="btn btn-primary btn-sm">Add Profile</button>
                </div>
                <div class="card-body">
                    <div id="image-thumbnail-profiles-container" class="profile-list"></div>
                </div>
            </div>
        </div>

        <div class="tab-content" id="face-detection">
            <div class="card">
                <div class="card-header">
                    <span>Face Detection Settings</span>
                </div>
                <div class="card-body">
                    <div class="toggle-container">
                        <label class="toggle">
                            <input type="checkbox" id="enable-face-detection" checked>
                            <span class="slider"></span>
                        </label>
                        <span>Enable Face Detection</span>
                    </div>

                    <div id="face-detection-settings" class="grid">
                        <div class="form-group">
                            <label for="similarity-threshold">Similarity Threshold</label>
                            <input type="number" id="similarity-threshold" min="0" max="1" step="0.05" value="0.6">
                        </div>
                        <div class="form-group">
                            <label for="min-faces-in-group">Min Faces in Group</label>
                            <input type="number" id="min-faces-in-group" min="1" value="3">
                        </div>
                        <div class="form-group">
                            <label for="sample-interval">Sample Interval</label>
                            <input type="number" id="sample-interval" min="1" value="5">
                        </div>
                        <div class="form-group">
                            <label for="face-detector-size">Face Detector Size</label>
                            <input type="text" id="face-detector-size" value="640x640">
                        </div>
                        <div class="form-group">
                            <label for="face-detector-score-threshold">Face Detector Score Threshold</label>
                            <input type="number" id="face-detector-score-threshold" min="0" max="1" step="0.05"
                                   value="0.6">
                        </div>
                        <div class="form-group">
                            <label for="min-appearance-ratio">Min Appearance Ratio</label>
                            <input type="number" id="min-appearance-ratio" min="0" max="1" step="0.05" value="0.15">
                        </div>
                        <div class="form-group">
                            <label for="min-frontality">Min Frontality</label>
                            <input type="number" id="min-frontality" min="0" max="1" step="0.05" value="0.2">
                        </div>
                        <div class="form-group">
                            <label for="avatar-size">Avatar Size</label>
                            <input type="number" id="avatar-size" min="32" value="256">
                        </div>
                        <div class="form-group">
                            <label for="avatar-padding">Avatar Padding</label>
                            <input type="number" id="avatar-padding" min="0" max="1" step="0.05" value="0.1">
                        </div>
                        <div class="form-group">
                            <label for="avatar-quality">Avatar Quality</label>
                            <input type="number" id="avatar-quality" min="1" max="100" value="90">
                        </div>
                        <div class="form-group">
                            <label for="output-path">Output Path</label>
                            <input type="text" id="output-path" value="./output/faces">
                        </div>
                        <div class="form-group">
                            <label for="max-workers">Max Workers</label>
                            <input type="number" id="max-workers" min="1" value="4">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Ignore Frames (comma separated)</label>
                        <input type="text" id="ignore-frames" placeholder="e.g. 0,1,2">
                    </div>

                    <div class="form-group">
                        <label>Ignore Ranges (comma separated ranges, e.g. 500-600,700-800)</label>
                        <input type="text" id="ignore-ranges" placeholder="e.g. 500-600,700-800">
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-content" id="output-settings">
            <div class="card">
                <div class="card-header">
                    <span>Output Settings</span>
                </div>
                <div class="card-body">
                    <div class="grid">
                        <div class="form-group">
                            <label for="s3-bucket">S3 Bucket</label>
                            <input type="text" id="s3-bucket" value="media-transcode-bucket">
                        </div>
                        <div class="form-group">
                            <label for="folder-structure">Folder Structure</label>
                            <input type="text" id="folder-structure" value="{user_id}/{job_id}/{type}/{profile_name}/">
                        </div>
                        <div class="form-group">
                            <label for="local-storage-path">Local Storage Path</label>
                            <input type="text" id="local-storage-path" value="/tmp/transcode-jobs/">
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="toggle-container">
                            <label class="toggle">
                                <input type="checkbox" id="generate-unique-filenames" checked>
                                <span class="slider"></span>
                            </label>
                            <span>Generate Unique Filenames</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="toggle-container">
                            <label class="toggle">
                                <input type="checkbox" id="preserve-original-filename" checked>
                                <span class="slider"></span>
                            </label>
                            <span>Preserve Original Filename</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="toggle-container">
                            <label class="toggle">
                                <input type="checkbox" id="use-temporary-local-storage" checked>
                                <span class="slider"></span>
                            </label>
                            <span>Use Temporary Local Storage</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="toggle-container">
                            <label class="toggle">
                                <input type="checkbox" id="delete-local-after-upload" checked>
                                <span class="slider"></span>
                            </label>
                            <span>Delete Local After Upload</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-content" id="json-preview">
            <div class="card">
                <div class="card-header">
                    <span>JSON Configuration</span>
                    <button id="copy-json" class="btn btn-secondary btn-sm">Copy JSON</button>
                </div>
                <div class="card-body">
                    <pre id="json-output" class="json-preview"></pre>
            </div>
        </div>
    </div>
    </div>

    <!-- Video Profile Modal -->
    <div id="video-profile-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">Add Video Transcode Profile</span>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="video-profile-name">Profile Name</label>
                    <input type="text" id="video-profile-name" placeholder="e.g. 720p">
                </div>
                <div class="form-group">
                    <label for="video-profile-width">Width</label>
                    <input type="number" id="video-profile-width" min="1" value="1280">
            </div>
                <div class="form-group">
                    <label for="video-profile-height">Height</label>
                    <input type="number" id="video-profile-height" min="1" value="720">
                </div>
                <div class="form-group">
                    <label for="video-profile-codec">Codec</label>
                    <select id="video-profile-codec">
                        <option value="libx264">libx264</option>
                        <option value="libx265">libx265</option>
                        <option value="libvpx-vp9">libvpx-vp9</option>
                        <option value="av1">av1</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="video-profile-preset">Preset</label>
                    <select id="video-profile-preset">
                        <option value="ultrafast">ultrafast</option>
                        <option value="superfast">superfast</option>
                        <option value="veryfast">veryfast</option>
                        <option value="faster">faster</option>
                        <option value="fast">fast</option>
                        <option value="medium" selected>medium</option>
                        <option value="slow">slow</option>
                        <option value="slower">slower</option>
                        <option value="veryslow">veryslow</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="video-profile-crf">CRF (Quality, lower is better)</label>
                    <input type="number" id="video-profile-crf" min="0" max="51" value="23">
                </div>
                <div class="form-group">
                    <label for="video-profile-format">Format</label>
                    <select id="video-profile-format">
                        <option value="mp4">mp4</option>
                        <option value="webm">webm</option>
                        <option value="mov">mov</option>
                        <option value="mkv">mkv</option>
                    </select>
            </div>
                <div class="form-group">
                    <label for="video-profile-audio-codec">Audio Codec</label>
                    <select id="video-profile-audio-codec">
                        <option value="aac">aac</option>
                        <option value="libmp3lame">mp3</option>
                        <option value="libopus">opus</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="video-profile-audio-bitrate">Audio Bitrate</label>
                    <input type="text" id="video-profile-audio-bitrate" value="128k">
                </div>
                <div class="form-group">
                    <div class="toggle-container">
                        <label class="toggle">
                            <input type="checkbox" id="video-profile-use-gpu" checked>
                            <span class="slider"></span>
                        </label>
                        <span>Use GPU Acceleration</span>
                    </div>
                </div>
                <div id="gpu-options-container">
                    <div class="form-group">
                        <label for="video-profile-gpu-encoder">Hardware Encoder</label>
                        <select id="video-profile-gpu-encoder">
                            <option value="h264_nvenc">h264_nvenc (NVIDIA)</option>
                            <option value="h264_qsv">h264_qsv (Intel QuickSync)</option>
                            <option value="h264_amf">h264_amf (AMD)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="video-profile-gpu-preset">GPU Preset</label>
                        <select id="video-profile-gpu-preset">
                            <option value="p1">p1 (Highest Quality)</option>
                            <option value="p2">p2</option>
                            <option value="p3">p3</option>
                            <option value="p4" selected>p4</option>
                            <option value="p5">p5</option>
                            <option value="p6">p6</option>
                            <option value="p7">p7 (Fastest)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="video-profile-gpu-rc">Rate Control</label>
                        <select id="video-profile-gpu-rc">
                            <option value="vbr" selected>Variable Bitrate (VBR)</option>
                            <option value="cbr">Constant Bitrate (CBR)</option>
                            <option value="cqp">Constant QP (CQP)</option>
                        </select>
                </div>
                </div>
                <div class="form-group">
                    <label for="video-profile-start">Start Time (seconds, optional)</label>
                    <input type="number" id="video-profile-start" min="0" placeholder="Leave empty for beginning">
            </div>
                <div class="form-group">
                    <label for="video-profile-end">End Time (seconds, optional)</label>
                    <input type="number" id="video-profile-end" min="0" placeholder="Leave empty for full duration">
                </div>
            </div>
            <div class="modal-footer">
                <button id="video-profile-cancel" class="btn btn-secondary">Cancel</button>
                <button id="video-profile-save" class="btn btn-primary">Save Profile</button>
            </div>
        </div>
    </div>

    <!-- Preview Profile Modal -->
    <div id="preview-profile-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">Add Preview Profile</span>
                <button class="modal-close">&times;</button>
        </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="preview-profile-name">Profile Name</label>
                    <input type="text" id="preview-profile-name" placeholder="e.g. small_gif">
                </div>
                <div class="form-group">
                    <label for="preview-profile-start">Start Time (seconds)</label>
                    <input type="number" id="preview-profile-start" min="0" value="0">
                </div>
                <div class="form-group">
                    <label for="preview-profile-end">End Time (seconds)</label>
                    <input type="number" id="preview-profile-end" min="0" value="5">
                </div>
                <div class="form-group">
                    <label for="preview-profile-fps">FPS</label>
                    <input type="number" id="preview-profile-fps" min="1" value="10">
                </div>
                <div class="form-group">
                    <label for="preview-profile-width">Width</label>
                    <input type="number" id="preview-profile-width" min="1" value="320">
                </div>
                <div class="form-group">
                    <label for="preview-profile-height">Height</label>
                    <input type="number" id="preview-profile-height" min="1" value="180">
                </div>
                <div class="form-group">
                    <label for="preview-profile-quality">Quality (1-100)</label>
                    <input type="number" id="preview-profile-quality" min="1" max="100" value="80">
                </div>
            </div>
            <div class="modal-footer">
                <button id="preview-profile-cancel" class="btn btn-secondary">Cancel</button>
                <button id="preview-profile-save" class="btn btn-primary">Save Profile</button>
            </div>
        </div>
    </div>

    <!-- Video Thumbnail Profile Modal -->
    <div id="video-thumbnail-profile-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">Add Video Thumbnail Profile</span>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="video-thumbnail-profile-name">Profile Name</label>
                    <input type="text" id="video-thumbnail-profile-name" placeholder="e.g. small">
                </div>
                <div class="form-group">
                    <label for="video-thumbnail-profile-width">Width</label>
                    <input type="number" id="video-thumbnail-profile-width" min="1" value="320">
            </div>
                <div class="form-group">
                    <label for="video-thumbnail-profile-height">Height</label>
                    <input type="number" id="video-thumbnail-profile-height" min="1" value="180">
                </div>
                <div class="form-group">
                    <label for="video-thumbnail-profile-format">Format</label>
                    <select id="video-thumbnail-profile-format">
                        <option value="jpg">jpg</option>
                        <option value="png">png</option>
                        <option value="webp">webp</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="video-thumbnail-profile-quality">Quality (1-100)</label>
                    <input type="number" id="video-thumbnail-profile-quality" min="1" max="100" value="90">
            </div>
        </div>
            <div class="modal-footer">
                <button id="video-thumbnail-profile-cancel" class="btn btn-secondary">Cancel</button>
                <button id="video-thumbnail-profile-save" class="btn btn-primary">Save Profile</button>
            </div>
        </div>
    </div>

    <!-- Image Profile Modal -->
    <div id="image-profile-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">Add Image Transcode Profile</span>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="image-profile-name">Profile Name</label>
                    <input type="text" id="image-profile-name" placeholder="e.g. original_webp">
                </div>
                <div class="form-group">
                    <label for="image-profile-format">Format</label>
                    <select id="image-profile-format">
                        <option value="webp">webp</option>
                        <option value="jpg">jpg</option>
                        <option value="png">png</option>
                        <option value="avif">avif</option>
                    </select>
                </div>
                <div id="image-quality-container" class="form-group">
                    <label for="image-profile-quality">Quality (1-100)</label>
                    <input type="number" id="image-profile-quality" min="1" max="100" value="90">
            </div>
                <div id="image-compression-container" class="form-group hidden">
                    <label for="image-profile-compression">Compression Level (0-9)</label>
                    <input type="number" id="image-profile-compression" min="0" max="9" value="6">
                </div>
                <div class="form-group">
                    <div class="toggle-container">
                        <label class="toggle">
                            <input type="checkbox" id="image-profile-resize">
                            <span class="slider"></span>
                        </label>
                        <span>Resize Image</span>
                    </div>
                </div>
                <div id="image-resize-options" class="hidden">
                    <div class="form-group">
                        <label for="image-profile-width">Width</label>
                        <input type="number" id="image-profile-width" min="1" value="2048">
                    </div>
                    <div class="form-group">
                        <label for="image-profile-height">Height</label>
                        <input type="number" id="image-profile-height" min="1" value="2048">
                    </div>
                    <div class="form-group">
                        <div class="toggle-container">
                            <label class="toggle">
                                <input type="checkbox" id="image-profile-maintain-aspect" checked>
                                <span class="slider"></span>
                            </label>
                            <span>Maintain Aspect Ratio</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="image-profile-cancel" class="btn btn-secondary">Cancel</button>
                <button id="image-profile-save" class="btn btn-primary">Save Profile</button>
        </div>
        </div>
    </div>

    <!-- Image Thumbnail Profile Modal -->
    <div id="image-thumbnail-profile-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">Add Image Thumbnail Profile</span>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="image-thumbnail-profile-name">Profile Name</label>
                    <input type="text" id="image-thumbnail-profile-name" placeholder="e.g. small">
                </div>
                <div class="form-group">
                    <label for="image-thumbnail-profile-width">Width</label>
                    <input type="number" id="image-thumbnail-profile-width" min="1" value="320">
                </div>
                <div class="form-group">
                    <label for="image-thumbnail-profile-height">Height</label>
                    <input type="number" id="image-thumbnail-profile-height" min="1" value="240">
                </div>
                <div class="form-group">
                    <div class="toggle-container">
                        <label class="toggle">
                            <input type="checkbox" id="image-thumbnail-profile-maintain-aspect" checked>
                            <span class="slider"></span>
                        </label>
                        <span>Maintain Aspect Ratio</span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="image-thumbnail-profile-format">Format</label>
                    <select id="image-thumbnail-profile-format">
                        <option value="webp">webp</option>
                        <option value="jpg">jpg</option>
                        <option value="png">png</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="image-thumbnail-profile-quality">Quality (1-100)</label>
                    <input type="number" id="image-thumbnail-profile-quality" min="1" max="100" value="85">
                </div>
            </div>
            <div class="modal-footer">
                <button id="image-thumbnail-profile-cancel" class="btn btn-secondary">Cancel</button>
                <button id="image-thumbnail-profile-save" class="btn btn-primary">Save Profile</button>
            </div>
        </div>
    </div>

    <!-- Load Config Modal -->
    <div id="load-config-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">Load Configuration</span>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="load-config-input">Paste JSON Configuration</label>
                    <textarea id="load-config-input" rows="10"
                              placeholder="Paste your JSON configuration here"></textarea>
            </div>
        </div>
            <div class="modal-footer">
                <button id="load-config-cancel" class="btn btn-secondary">Cancel</button>
                <button id="load-config-confirm" class="btn btn-primary">Load</button>
            </div>
        </div>
    </div>
    </body>
{% endblock %}
{% block js %}
<script>
    function renderImageThumbnailProfiles() {
        elements.imageThumbnailProfilesContainer.innerHTML = '';

        if (!config.image_settings.thumbnail_profiles.length) {
            elements.imageThumbnailProfilesContainer.innerHTML = '<p>No image thumbnail profiles defined.</p>';
            return;
        }

        config.image_settings.thumbnail_profiles.forEach((profile, index) => {
            const profileItem = document.createElement('div');
            profileItem.className = 'profile-item';

            const nameSpan = document.createElement('span');
            const aspectInfo = profile.maintain_aspect_ratio ? ' (maintain aspect)' : '';
            nameSpan.textContent = `${profile.name} (${profile.width}x${profile.height}, ${profile.format}${aspectInfo})`;
            profileItem.appendChild(nameSpan);

            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'profile-item-actions';

            const editBtn = document.createElement('button');
            editBtn.className = 'btn btn-primary btn-sm';
            editBtn.textContent = 'Edit';
            editBtn.addEventListener('click', () => {
                currentEditingIndex = index;
                populateImageThumbnailProfileForm(profile);
                openModal(elements.imageThumbnailProfileModal);
            });
            actionsDiv.appendChild(editBtn);

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'btn btn-danger btn-sm';
            deleteBtn.textContent = 'Delete';
            deleteBtn.addEventListener('click', () => {
                if (confirm('Are you sure you want to delete this profile?')) {
                    config.image_settings.thumbnail_profiles.splice(index, 1);
                    renderImageThumbnailProfiles();
                    updateJsonPreview();
                }
            });
            actionsDiv.appendChild(deleteBtn);

            profileItem.appendChild(actionsDiv);
            elements.imageThumbnailProfilesContainer.appendChild(profileItem);
        });
    }

    // Update UI based on config
    function updateUiFromConfig() {
        // Basic configuration
        elements.configName.value = config.config_name || '';
        elements.configDescription.value = config.description || '';

        // Video settings
        const hasVideoSettings = config.video_settings && Object.keys(config.video_settings).length > 0;
        elements.enableVideoSettings.checked = hasVideoSettings;

        if (hasVideoSettings) {
            if (config.video_settings.thumbnail_settings && config.video_settings.thumbnail_settings.timestamp) {
                elements.thumbnailTimestamp.value = config.video_settings.thumbnail_settings.timestamp;
            }

            renderVideoProfiles();
            renderPreviewProfiles();
            renderVideoThumbnailProfiles();
        } else {
            elements.videoProfilesContainer.innerHTML = '<p>No video transcode profiles defined.</p>';
            elements.previewProfilesContainer.innerHTML = '<p>No preview profiles defined.</p>';
            elements.videoThumbnailProfilesContainer.innerHTML = '<p>No video thumbnail profiles defined.</p>';
        }

        // Image settings
        const hasImageSettings = config.image_settings && Object.keys(config.image_settings).length > 0;
        elements.enableImageSettings.checked = hasImageSettings;

        if (hasImageSettings) {
            renderImageProfiles();
            renderImageThumbnailProfiles();
        } else {
            elements.imageProfilesContainer.innerHTML = '<p>No image transcode profiles defined.</p>';
            elements.imageThumbnailProfilesContainer.innerHTML = '<p>No image thumbnail profiles defined.</p>';
        }

        // Face detection settings
        const hasFaceDetection = config.face_detection && config.face_detection.enabled;
        elements.enableFaceDetection.checked = hasFaceDetection;

        if (hasFaceDetection && config.face_detection.config) {
            const fd = config.face_detection.config;

            document.getElementById('similarity-threshold').value = fd.similarity_threshold || 0.6;
            document.getElementById('min-faces-in-group').value = fd.min_faces_in_group || 3;
            document.getElementById('sample-interval').value = fd.sample_interval || 5;
            document.getElementById('face-detector-size').value = fd.face_detector_size || '640x640';
            document.getElementById('face-detector-score-threshold').value = fd.face_detector_score_threshold || 0.6;
            document.getElementById('min-appearance-ratio').value = fd.min_appearance_ratio || 0.15;
            document.getElementById('min-frontality').value = fd.min_frontality || 0.2;
            document.getElementById('avatar-size').value = fd.avatar_size || 256;
            document.getElementById('avatar-padding').value = fd.avatar_padding || 0.1;
            document.getElementById('avatar-quality').value = fd.avatar_quality || 90;
            document.getElementById('output-path').value = fd.output_path || './output/faces';
            document.getElementById('max-workers').value = fd.max_workers || 4;

            // Ignore frames and ranges
            if (fd.ignore_frames && Array.isArray(fd.ignore_frames)) {
                elements.ignoreFrames.value = fd.ignore_frames.join(',');
            }

            if (fd.ignore_ranges && Array.isArray(fd.ignore_ranges)) {
                const ranges = fd.ignore_ranges.map(range => range.join('-')).join(',');
                elements.ignoreRanges.value = ranges;
            }
        }

        // Output settings
        if (config.output_settings) {
            const os = config.output_settings;
            elements.s3Bucket.value = os.s3_bucket || 'media-transcode-bucket';
            elements.folderStructure.value = os.folder_structure || '{user_id}/{job_id}/{type}/{profile_name}/';
            elements.localStoragePath.value = os.local_storage_path || '/tmp/transcode-jobs/';
            elements.generateUniqueFilenames.checked = os.generate_unique_filenames !== undefined ? os.generate_unique_filenames : true;
            elements.preserveOriginalFilename.checked = os.preserve_original_filename !== undefined ? os.preserve_original_filename : true;
            elements.useTemporaryLocalStorage.checked = os.use_temporary_local_storage !== undefined ? os.use_temporary_local_storage : true;
            elements.deleteLocalAfterUpload.checked = os.delete_local_after_upload !== undefined ? os.delete_local_after_upload : true;
        }

        // Update UI based on toggle states
        const videoSettingsCards = document.querySelectorAll('#video-settings .card:not(:first-child)');
        videoSettingsCards.forEach(card => {
            card.style.opacity = elements.enableVideoSettings.checked ? '1' : '0.5';
            card.style.pointerEvents = elements.enableVideoSettings.checked ? 'auto' : 'none';
        });

        const imageSettingsCards = document.querySelectorAll('#image-settings .card');
        imageSettingsCards.forEach(card => {
            card.style.opacity = elements.enableImageSettings.checked ? '1' : '0.5';
            card.style.pointerEvents = elements.enableImageSettings.checked ? 'auto' : 'none';
    });

        elements.faceDetectionSettings.style.opacity = elements.enableFaceDetection.checked ? '1' : '0.5';
        elements.faceDetectionSettings.style.pointerEvents = elements.enableFaceDetection.checked ? 'auto' : 'none';
        elements.ignoreFrames.parentNode.style.opacity = elements.enableFaceDetection.checked ? '1' : '0.5';
        elements.ignoreFrames.parentNode.style.pointerEvents = elements.enableFaceDetection.checked ? 'auto' : 'none';
        elements.ignoreRanges.parentNode.style.opacity = elements.enableFaceDetection.checked ? '1' : '0.5';
        elements.ignoreRanges.parentNode.style.pointerEvents = elements.enableFaceDetection.checked ? 'auto' : 'none';
    }

    // Update config from UI
    function updateConfigFromUi() {
        // Basic configuration
        config.config_name = elements.configName.value;
        config.description = elements.configDescription.value;
        config.created_at = new Date().toISOString();

        // Video settings
        const enableVideo = elements.enableVideoSettings.checked;
        if (!enableVideo) {
            delete config.video_settings;
        } else {
            config.video_settings = config.video_settings || {
                transcode_profiles: [],
                preview_settings: {
                    profiles: []
                },
                thumbnail_settings: {
                    timestamp: parseInt(elements.thumbnailTimestamp.value) || 5,
                    profiles: []
                }
        };

            config.video_settings.thumbnail_settings.timestamp = parseInt(elements.thumbnailTimestamp.value) || 5;
        }

        // Image settings
        const enableImage = elements.enableImageSettings.checked;
        if (!enableImage) {
            delete config.image_settings;
        } else {
            config.image_settings = config.image_settings || {
                transcode_profiles: [],
                thumbnail_profiles: []
            };
        }

        // Face detection settings
        const enableFaceDetection = elements.enableFaceDetection.checked;
        config.face_detection = {
            enabled: enableFaceDetection
        };

        if (enableFaceDetection) {
            const ignoreFrames = elements.ignoreFrames.value.trim();
            const ignoreRanges = elements.ignoreRanges.value.trim();

            config.face_detection.config = {
                similarity_threshold: parseFloat(document.getElementById('similarity-threshold').value) || 0.6,
                min_faces_in_group: parseInt(document.getElementById('min-faces-in-group').value) || 3,
                sample_interval: parseInt(document.getElementById('sample-interval').value) || 5,
                face_detector_size: document.getElementById('face-detector-size').value || '640x640',
                face_detector_score_threshold: parseFloat(document.getElementById('face-detector-score-threshold').value) || 0.6,
                min_appearance_ratio: parseFloat(document.getElementById('min-appearance-ratio').value) || 0.15,
                min_frontality: parseFloat(document.getElementById('min-frontality').value) || 0.2,
                avatar_size: parseInt(document.getElementById('avatar-size').value) || 256,
                avatar_padding: parseFloat(document.getElementById('avatar-padding').value) || 0.1,
                avatar_quality: parseInt(document.getElementById('avatar-quality').value) || 90,
                output_path: document.getElementById('output-path').value || './output/faces',
                max_workers: parseInt(document.getElementById('max-workers').value) || 4
            };

            if (ignoreFrames) {
                config.face_detection.config.ignore_frames = ignoreFrames.split(',').map(n => parseInt(n.trim()));
            }

            if (ignoreRanges) {
                config.face_detection.config.ignore_ranges = ignoreRanges.split(',').map(range => {
                    const [start, end] = range.split('-').map(n => parseInt(n.trim()));
                    return [start, end];
                });
            }
        }

        // Output settings
        config.output_settings = {
            s3_bucket: elements.s3Bucket.value,
            folder_structure: elements.folderStructure.value,
            local_storage_path: elements.localStoragePath.value,
            generate_unique_filenames: elements.generateUniqueFilenames.checked,
            preserve_original_filename: elements.preserveOriginalFilename.checked,
            use_temporary_local_storage: elements.useTemporaryLocalStorage.checked,
            delete_local_after_upload: elements.deleteLocalAfterUpload.checked
        };
    }

    // Update JSON preview
    function updateJsonPreview() {
        updateConfigFromUi();
        elements.jsonOutput.textContent = JSON.stringify(config, null, 2);
    }

    // Reset configuration
    function resetConfig() {
        config = {
            config_name: "",
            description: "",
            created_at: new Date().toISOString(),
            video_settings: {
                transcode_profiles: [],
                preview_settings: {
                    profiles: []
            },
                thumbnail_settings: {
                    timestamp: 5,
                    profiles: []
                }
            },
            image_settings: {
                transcode_profiles: [],
                thumbnail_profiles: []
            },
            face_detection: {
                enabled: false,
                config: {
                    similarity_threshold: 0.6,
                    min_faces_in_group: 3,
                    sample_interval: 5,
                    face_detector_size: "640x640",
                    face_detector_score_threshold: 0.6,
                    min_appearance_ratio: 0.15,
                    min_frontality: 0.2,
                    avatar_size: 256,
                    avatar_padding: 0.1,
                    avatar_quality: 90,
                    output_path: "./output/faces",
                    max_workers: 4
                }
            },
            output_settings: {
                s3_bucket: "media-transcode-bucket",
                folder_structure: "{user_id}/{job_id}/{type}/{profile_name}/",
                generate_unique_filenames: true,
                preserve_original_filename: true,
                use_temporary_local_storage: true,
                local_storage_path: "/tmp/transcode-jobs/",
                delete_local_after_upload: true
            }
        };

        updateUiFromConfig();
        updateJsonPreview();
        showAlert('Configuration reset', 'info');
    }

    // Show alert
    function showAlert(message, type = 'info') {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type}`;
        alertDiv.textContent = message;

        // Remove any existing alerts
        const existingAlerts = document.querySelectorAll('.alert');
        existingAlerts.forEach(alert => {
            if (alert.classList.contains('alert-info')) {
                alert.remove();
            }
        });

        // Insert after header
        const header = document.querySelector('.header');
        header.parentNode.insertBefore(alertDiv, header.nextSibling);

        // Auto remove after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.parentNode.removeChild(alertDiv);
            }
        }, 5000);
    }

    // Initialize UI
    function init() {
        renderVideoProfiles();
        renderPreviewProfiles();
        renderVideoThumbnailProfiles();
        renderImageProfiles();
        renderImageThumbnailProfiles();
        updateJsonPreview();
    }

    // Ready state handler
    document.addEventListener('DOMContentLoaded', init);// Main data store for the configuration
    let config = {
        config_name: "",
        description: "",
        created_at: new Date().toISOString(),
        video_settings: {
            transcode_profiles: [],
            preview_settings: {
                profiles: []
            },
            thumbnail_settings: {
                timestamp: 5,
                profiles: []
            }
        },
        image_settings: {
            transcode_profiles: [],
            thumbnail_profiles: []
        },
        face_detection: {
            enabled: true,
            config: {
                similarity_threshold: 0.6,
                min_faces_in_group: 3,
                sample_interval: 5,
                ignore_frames: [0, 1, 2],
                ignore_ranges: [[500, 600]],
                face_detector_size: "640x640",
                face_detector_score_threshold: 0.6,
                min_appearance_ratio: 0.15,
                min_frontality: 0.2,
                avatar_size: 256,
                avatar_padding: 0.1,
                avatar_quality: 90,
                output_path: "./output/faces",
                max_workers: 4
            }
        },
        output_settings: {
            s3_bucket: "media-transcode-bucket",
            folder_structure: "{user_id}/{job_id}/{type}/{profile_name}/",
            generate_unique_filenames: true,
            preserve_original_filename: true,
            use_temporary_local_storage: true,
            local_storage_path: "/tmp/transcode-jobs/",
            delete_local_after_upload: true
        }
    };

    // Sample configuration templates
    const configTemplates = {
        "high-quality": "high-quality.json",
        "standard": "standard.json",
        "minimal": "minimal.json",
        "video-only": "video-only.json",
        "image-only": "image-only.json",
        "custom": null
    };

    // Cache DOM elements
    const elements = {
        loading: document.querySelector('.loading'),
        tabs: document.querySelectorAll('.tab'),
        tabContents: document.querySelectorAll('.tab-content'),
        configTemplates: document.querySelectorAll('.config-template'),
        videoProfilesContainer: document.getElementById('video-profiles-container'),
        previewProfilesContainer: document.getElementById('preview-profiles-container'),
        videoThumbnailProfilesContainer: document.getElementById('video-thumbnail-profiles-container'),
        imageProfilesContainer: document.getElementById('image-profiles-container'),
        imageThumbnailProfilesContainer: document.getElementById('image-thumbnail-profiles-container'),
        jsonOutput: document.getElementById('json-output'),
        configName: document.getElementById('config-name'),
        configDescription: document.getElementById('config-description'),
        thumbnailTimestamp: document.getElementById('thumbnail-timestamp'),
        enableVideoSettings: document.getElementById('enable-video-settings'),
        enableImageSettings: document.getElementById('enable-image-settings'),
        enableFaceDetection: document.getElementById('enable-face-detection'),
        faceDetectionSettings: document.getElementById('face-detection-settings'),
        ignoreFrames: document.getElementById('ignore-frames'),
        ignoreRanges: document.getElementById('ignore-ranges'),
        s3Bucket: document.getElementById('s3-bucket'),
        folderStructure: document.getElementById('folder-structure'),
        localStoragePath: document.getElementById('local-storage-path'),
        generateUniqueFilenames: document.getElementById('generate-unique-filenames'),
        preserveOriginalFilename: document.getElementById('preserve-original-filename'),
        useTemporaryLocalStorage: document.getElementById('use-temporary-local-storage'),
        deleteLocalAfterUpload: document.getElementById('delete-local-after-upload'),
        // For modal forms
        videoProfileModal: document.getElementById('video-profile-modal'),
        previewProfileModal: document.getElementById('preview-profile-modal'),
        videoThumbnailProfileModal: document.getElementById('video-thumbnail-profile-modal'),
        imageProfileModal: document.getElementById('image-profile-modal'),
        imageThumbnailProfileModal: document.getElementById('image-thumbnail-profile-modal'),
        loadConfigModal: document.getElementById('load-config-modal'),
        // Buttons
        addVideoProfileBtn: document.getElementById('add-video-profile'),
        addPreviewProfileBtn: document.getElementById('add-preview-profile'),
        addVideoThumbnailProfileBtn: document.getElementById('add-video-thumbnail-profile'),
        addImageProfileBtn: document.getElementById('add-image-profile'),
        addImageThumbnailProfileBtn: document.getElementById('add-image-thumbnail-profile'),
        loadConfigBtn: document.getElementById('load-config'),
        saveConfigBtn: document.getElementById('save-config'),
        copyJsonBtn: document.getElementById('copy-json'),
        // Modal close buttons
        modalCloseButtons: document.querySelectorAll('.modal-close'),
        // Form elements in modals
        videoProfileSaveBtn: document.getElementById('video-profile-save'),
        videoProfileCancelBtn: document.getElementById('video-profile-cancel'),
        previewProfileSaveBtn: document.getElementById('preview-profile-save'),
        previewProfileCancelBtn: document.getElementById('preview-profile-cancel'),
        videoThumbnailProfileSaveBtn: document.getElementById('video-thumbnail-profile-save'),
        videoThumbnailProfileCancelBtn: document.getElementById('video-thumbnail-profile-cancel'),
        imageProfileSaveBtn: document.getElementById('image-profile-save'),
        imageProfileCancelBtn: document.getElementById('image-profile-cancel'),
        imageThumbnailProfileSaveBtn: document.getElementById('image-thumbnail-profile-save'),
        imageThumbnailProfileCancelBtn: document.getElementById('image-thumbnail-profile-cancel'),
        loadConfigConfirmBtn: document.getElementById('load-config-confirm'),
        loadConfigCancelBtn: document.getElementById('load-config-cancel'),
        loadConfigInput: document.getElementById('load-config-input'),
        // Specific modal form elements
        videoProfileUseGpu: document.getElementById('video-profile-use-gpu'),
        gpuOptionsContainer: document.getElementById('gpu-options-container'),
        imageProfileResize: document.getElementById('image-profile-resize'),
        imageResizeOptions: document.getElementById('image-resize-options'),
        imageProfileFormat: document.getElementById('image-profile-format'),
        imageQualityContainer: document.getElementById('image-quality-container'),
        imageCompressionContainer: document.getElementById('image-compression-container')
    };

    // State variables
    let currentEditingIndex = null;
    let currentProfileType = null;

    // Initialize tabs
    elements.tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            elements.tabs.forEach(t => t.classList.remove('active'));
            elements.tabContents.forEach(content => content.classList.remove('active'));

            tab.classList.add('active');
            const tabId = tab.getAttribute('data-tab');
            document.getElementById(tabId).classList.add('active');

            // Update JSON preview whenever we switch to it
            if (tabId === 'json-preview') {
                updateJsonPreview();
            }
        });
    });

    // Modal handling
    function openModal(modalElement) {
        modalElement.style.display = 'flex';
    }

    function closeModal(modalElement) {
        modalElement.style.display = 'none';
    }

    elements.modalCloseButtons.forEach(button => {
        button.addEventListener('click', () => {
            const modal = button.closest('.modal');
            closeModal(modal);
        });
    });

    // Close modal when clicking outside
    window.addEventListener('click', (event) => {
        if (event.target.classList.contains('modal')) {
            closeModal(event.target);
        }
    });

    // Config template selection
    elements.configTemplates.forEach(template => {
        template.addEventListener('click', async () => {
            elements.configTemplates.forEach(t => t.classList.remove('active'));
            template.classList.add('active');

            const templateName = template.getAttribute('data-template');

            if (templateName === 'custom') {
                resetConfig();
                return;
            }

            // Load the selected template
            elements.loading.style.display = 'flex';
            try {
                // Load the template from the predefined data
                const templateFile = configTemplates[templateName];
                await loadTemplateConfig(templateFile);
            } catch (error) {
                console.error('Error loading template:', error);
                showAlert('Error loading template configuration', 'danger');
            } finally {
                elements.loading.style.display = 'none';
            }
        });
    });

    function saveConfig(config) {

        // Save configuration
        const token = localStorage.getItem('token');

        fetch('/api/configs', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                name: config.config_name,
                description: config.description,
                config_json: config
            })
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to save configuration');
                }
                return response.json();
            })
            .catch(error => {
                console.error('Error saving configuration:', error);
                showAlert('Failed to save configuration. Please try again.', 'error');
            })
            .finally(() => {
                // Re-enable button
                saveButton.disabled = false;
                saveButton.innerHTML = '<i class="fas fa-save me-2"></i>Save Configuration';
            });
    }

    // Function to simulate API calls (for demonstration)
    function simulateApiCall(delay = 500) {
        return saveConfig()
    }

    // API call to load a template configuration
    async function loadTemplateConfig(templateFile) {
        try {
            // In a real application, this would fetch from your API
            // For this demo, we'll simulate loading from a predefined object
            const urlTemplate = `/static/js/templates/${templateFile}`
            {#alert(urlTemplate)#}
            console.log("templateFile", templateFile)
            console.log("urlTemplate", urlTemplate)
            const response = await fetch(urlTemplate);
            if (!response.ok) {
                throw new Error(`Failed to load template: ${response.statusText}`);
            }

            const data = await response.json();
            config = data;

            // Update UI with the loaded config
            updateUiFromConfig();
            updateJsonPreview();
            showAlert('Template configuration loaded successfully', 'success');
        } catch (error) {
            console.error('Error loading template config:', error);
            showAlert('Error loading template configuration', 'danger');
        }
    }

    // Button event listeners
    elements.addVideoProfileBtn.addEventListener('click', () => {
        currentEditingIndex = null;
        currentProfileType = 'video';
        resetVideoProfileForm();
        openModal(elements.videoProfileModal);
    });

    elements.addPreviewProfileBtn.addEventListener('click', () => {
        currentEditingIndex = null;
        resetPreviewProfileForm();
        openModal(elements.previewProfileModal);
    });

    elements.addVideoThumbnailProfileBtn.addEventListener('click', () => {
        currentEditingIndex = null;
        resetVideoThumbnailProfileForm();
        openModal(elements.videoThumbnailProfileModal);
    });

    elements.addImageProfileBtn.addEventListener('click', () => {
        currentEditingIndex = null;
        currentProfileType = 'image';
        resetImageProfileForm();
        openModal(elements.imageProfileModal);
    });

    elements.addImageThumbnailProfileBtn.addEventListener('click', () => {
        currentEditingIndex = null;
        resetImageThumbnailProfileForm();
        openModal(elements.imageThumbnailProfileModal);
    });

    elements.loadConfigBtn.addEventListener('click', () => {
        openModal(elements.loadConfigModal);
    });

    elements.loadConfigConfirmBtn.addEventListener('click', () => {
        const jsonText = elements.loadConfigInput.value.trim();
        if (!jsonText) {
            showAlert('Please paste a valid JSON configuration', 'warning');
            return;
        }

        try {
            const loadedConfig = JSON.parse(jsonText);
            config = loadedConfig;
            updateUiFromConfig();
            closeModal(elements.loadConfigModal);
            elements.configTemplates.forEach(t => t.classList.remove('active'));
            document.querySelector('.config-template[data-template="custom"]').classList.add('active');
            showAlert('Configuration loaded successfully', 'success');
            updateJsonPreview();
        } catch (error) {
            console.error('Error parsing JSON:', error);
            showAlert('Invalid JSON configuration', 'danger');
        }
    });

    elements.loadConfigCancelBtn.addEventListener('click', () => {
        closeModal(elements.loadConfigModal);
    });

    elements.saveConfigBtn.addEventListener('click', async () => {
        updateConfigFromUi();

        // Validate config before saving
        if (!config.config_name) {
            showAlert('Please enter a configuration name', 'warning');
            return;
        }

        elements.loading.style.display = 'flex';
        try {
            // Simulate API call to save config
            // In a real app, this would be an actual fetch to your backend
            await saveConfig(config)

            // In a real application, you would send the config to your server
            console.log('Configuration saved:', config);
            showAlert('Configuration saved successfully', 'success');
        } catch (error) {
            console.error('Error saving configuration:', error);
            showAlert('Error saving configuration', 'danger');
        } finally {
            elements.loading.style.display = 'none';
        }
    });

    elements.copyJsonBtn.addEventListener('click', () => {
        updateConfigFromUi();
        updateJsonPreview();

        const jsonText = elements.jsonOutput.textContent;

        if (navigator.clipboard) {
            navigator.clipboard.writeText(jsonText)
                .then(() => {
                    showAlert('JSON copied to clipboard', 'success');
                })
                .catch(() => {
                    showAlert('Failed to copy JSON to clipboard', 'danger');
                });
        } else {
            // Fallback for browsers without clipboard API
            const textarea = document.createElement('textarea');
            textarea.value = jsonText;
            document.body.appendChild(textarea);
            textarea.select();

            try {
                document.execCommand('copy');
                showAlert('JSON copied to clipboard', 'success');
            } catch (err) {
                showAlert('Failed to copy JSON to clipboard', 'danger');
            }

            document.body.removeChild(textarea);
        }
    });

    // Setting toggle handlers
    elements.enableVideoSettings.addEventListener('change', function () {
        const videoSettingsCards = document.querySelectorAll('#video-settings .card:not(:first-child)');
        videoSettingsCards.forEach(card => {
            card.style.opacity = this.checked ? '1' : '0.5';
            card.style.pointerEvents = this.checked ? 'auto' : 'none';
        });
    });

    elements.enableImageSettings.addEventListener('change', function () {
        const imageSettingsCards = document.querySelectorAll('#image-settings .card');
        imageSettingsCards.forEach(card => {
            card.style.opacity = this.checked ? '1' : '0.5';
            card.style.pointerEvents = this.checked ? 'auto' : 'none';
        });
    });

    elements.enableFaceDetection.addEventListener('change', function () {
        elements.faceDetectionSettings.style.opacity = this.checked ? '1' : '0.5';
        elements.faceDetectionSettings.style.pointerEvents = this.checked ? 'auto' : 'none';
        elements.ignoreFrames.parentNode.style.opacity = this.checked ? '1' : '0.5';
        elements.ignoreFrames.parentNode.style.pointerEvents = this.checked ? 'auto' : 'none';
        elements.ignoreRanges.parentNode.style.opacity = this.checked ? '1' : '0.5';
        elements.ignoreRanges.parentNode.style.pointerEvents = this.checked ? 'auto' : 'none';
    });

    elements.videoProfileUseGpu.addEventListener('change', function () {
        elements.gpuOptionsContainer.style.display = this.checked ? 'block' : 'none';
    });

    elements.imageProfileResize.addEventListener('change', function () {
        elements.imageResizeOptions.style.display = this.checked ? 'block' : 'none';
    });

    elements.imageProfileFormat.addEventListener('change', function () {
        const format = this.value;
        if (format === 'png') {
            elements.imageQualityContainer.classList.add('hidden');
            elements.imageCompressionContainer.classList.remove('hidden');
        } else {
            elements.imageQualityContainer.classList.remove('hidden');
            elements.imageCompressionContainer.classList.add('hidden');
        }
    });

    // Save profile functions
    elements.videoProfileSaveBtn.addEventListener('click', () => {
        saveVideoProfile();
        closeModal(elements.videoProfileModal);
    });

    elements.previewProfileSaveBtn.addEventListener('click', () => {
        savePreviewProfile();
        closeModal(elements.previewProfileModal);
    });

    elements.videoThumbnailProfileSaveBtn.addEventListener('click', () => {
        saveVideoThumbnailProfile();
        closeModal(elements.videoThumbnailProfileModal);
    });

    elements.imageProfileSaveBtn.addEventListener('click', () => {
        saveImageProfile();
        closeModal(elements.imageProfileModal);
    });

    elements.imageThumbnailProfileSaveBtn.addEventListener('click', () => {
        saveImageThumbnailProfile();
        closeModal(elements.imageThumbnailProfileModal);
    });

    elements.videoProfileCancelBtn.addEventListener('click', () => {
        closeModal(elements.videoProfileModal);
    });

    elements.previewProfileCancelBtn.addEventListener('click', () => {
        closeModal(elements.previewProfileModal);
    });

    elements.videoThumbnailProfileCancelBtn.addEventListener('click', () => {
        closeModal(elements.videoThumbnailProfileModal);
    });

    elements.imageProfileCancelBtn.addEventListener('click', () => {
        closeModal(elements.imageProfileModal);
    });

    elements.imageThumbnailProfileCancelBtn.addEventListener('click', () => {
        closeModal(elements.imageThumbnailProfileModal);
    });

    // Function to save video profile from form
    function saveVideoProfile() {
        const profile = {
            name: document.getElementById('video-profile-name').value,
            width: parseInt(document.getElementById('video-profile-width').value),
            height: parseInt(document.getElementById('video-profile-height').value),
            codec: document.getElementById('video-profile-codec').value,
            preset: document.getElementById('video-profile-preset').value,
            crf: parseInt(document.getElementById('video-profile-crf').value),
            format: document.getElementById('video-profile-format').value,
            audio_codec: document.getElementById('video-profile-audio-codec').value,
            audio_bitrate: document.getElementById('video-profile-audio-bitrate').value,
            use_gpu: document.getElementById('video-profile-use-gpu').checked
        };

        // Add start/end times if provided
        const startTime = document.getElementById('video-profile-start').value;
        const endTime = document.getElementById('video-profile-end').value;

        if (startTime) {
            profile.start = parseInt(startTime);
        }

        if (endTime) {
            profile.end = parseInt(endTime);
        }

        // Add GPU options if enabled
        if (profile.use_gpu) {
            profile.gpu_options = {
                hardware_encoder: document.getElementById('video-profile-gpu-encoder').value,
                preset: document.getElementById('video-profile-gpu-preset').value,
                rc: document.getElementById('video-profile-gpu-rc').value
            };
        }

        if (currentEditingIndex !== null) {
            // Edit existing profile
            config.video_settings.transcode_profiles[currentEditingIndex] = profile;
        } else {
            // Add new profile
            config.video_settings.transcode_profiles.push(profile);
        }

        renderVideoProfiles();
        updateJsonPreview();
    }

    // Function to save preview profile from form
    function savePreviewProfile() {
        const profile = {
            name: document.getElementById('preview-profile-name').value,
            start: parseInt(document.getElementById('preview-profile-start').value),
            end: parseInt(document.getElementById('preview-profile-end').value),
            fps: parseInt(document.getElementById('preview-profile-fps').value),
            width: parseInt(document.getElementById('preview-profile-width').value),
            height: parseInt(document.getElementById('preview-profile-height').value),
            quality: parseInt(document.getElementById('preview-profile-quality').value)
        };

        if (currentEditingIndex !== null) {
            // Edit existing profile
            config.video_settings.preview_settings.profiles[currentEditingIndex] = profile;
        } else {
            // Add new profile
            config.video_settings.preview_settings.profiles.push(profile);
        }

        renderPreviewProfiles();
        updateJsonPreview();
    }

    // Function to save video thumbnail profile from form
    function saveVideoThumbnailProfile() {
        const profile = {
            name: document.getElementById('video-thumbnail-profile-name').value,
            width: parseInt(document.getElementById('video-thumbnail-profile-width').value),
            height: parseInt(document.getElementById('video-thumbnail-profile-height').value),
            format: document.getElementById('video-thumbnail-profile-format').value,
            quality: parseInt(document.getElementById('video-thumbnail-profile-quality').value)
        };

        if (currentEditingIndex !== null) {
            // Edit existing profile
            config.video_settings.thumbnail_settings.profiles[currentEditingIndex] = profile;
        } else {
            // Add new profile
            config.video_settings.thumbnail_settings.profiles.push(profile);
        }

        renderVideoThumbnailProfiles();
        updateJsonPreview();
    }

    // Function to save image profile from form
    function saveImageProfile() {
        const profile = {
            name: document.getElementById('image-profile-name').value,
            format: document.getElementById('image-profile-format').value,
            resize: document.getElementById('image-profile-resize').checked
        };

        // Add quality or compression based on format
        if (profile.format === 'png') {
            profile.compression_level = parseInt(document.getElementById('image-profile-compression').value);
        } else {
            profile.quality = parseInt(document.getElementById('image-profile-quality').value);
        }

        // Add resize options if enabled
        if (profile.resize) {
            profile.width = parseInt(document.getElementById('image-profile-width').value);
            profile.height = parseInt(document.getElementById('image-profile-height').value);
            profile.maintain_aspect_ratio = document.getElementById('image-profile-maintain-aspect').checked;
        }

        if (currentEditingIndex !== null) {
            // Edit existing profile
            config.image_settings.transcode_profiles[currentEditingIndex] = profile;
        } else {
            // Add new profile
            config.image_settings.transcode_profiles.push(profile);
        }

        renderImageProfiles();
        updateJsonPreview();
    }

    // Function to save image thumbnail profile from form
    function saveImageThumbnailProfile() {
        const profile = {
            name: document.getElementById('image-thumbnail-profile-name').value,
            width: parseInt(document.getElementById('image-thumbnail-profile-width').value),
            height: parseInt(document.getElementById('image-thumbnail-profile-height').value),
            maintain_aspect_ratio: document.getElementById('image-thumbnail-profile-maintain-aspect').checked,
            format: document.getElementById('image-thumbnail-profile-format').value,
            quality: parseInt(document.getElementById('image-thumbnail-profile-quality').value)
        };

        if (currentEditingIndex !== null) {
            // Edit existing profile
            config.image_settings.thumbnail_profiles[currentEditingIndex] = profile;
        } else {
            // Add new profile
            config.image_settings.thumbnail_profiles.push(profile);
        }

        renderImageThumbnailProfiles();
        updateJsonPreview();
    }

    // Reset form functions
    function resetVideoProfileForm() {
        document.getElementById('video-profile-name').value = '';
        document.getElementById('video-profile-width').value = '1280';
        document.getElementById('video-profile-height').value = '720';
        document.getElementById('video-profile-codec').value = 'libx264';
        document.getElementById('video-profile-preset').value = 'medium';
        document.getElementById('video-profile-crf').value = '23';
        document.getElementById('video-profile-format').value = 'mp4';
        document.getElementById('video-profile-audio-codec').value = 'aac';
        document.getElementById('video-profile-audio-bitrate').value = '128k';
        document.getElementById('video-profile-use-gpu').checked = true;
        document.getElementById('video-profile-gpu-encoder').value = 'h264_nvenc';
        document.getElementById('video-profile-gpu-preset').value = 'p4';
        document.getElementById('video-profile-gpu-rc').value = 'vbr';
        document.getElementById('video-profile-start').value = '';
        document.getElementById('video-profile-end').value = '';
        elements.gpuOptionsContainer.style.display = 'block';
    }

    function resetPreviewProfileForm() {
        document.getElementById('preview-profile-name').value = '';
        document.getElementById('preview-profile-start').value = '0';
        document.getElementById('preview-profile-end').value = '5';
        document.getElementById('preview-profile-fps').value = '10';
        document.getElementById('preview-profile-width').value = '320';
        document.getElementById('preview-profile-height').value = '180';
        document.getElementById('preview-profile-quality').value = '80';
    }

    function resetVideoThumbnailProfileForm() {
        document.getElementById('video-thumbnail-profile-name').value = '';
        document.getElementById('video-thumbnail-profile-width').value = '320';
        document.getElementById('video-thumbnail-profile-height').value = '180';
        document.getElementById('video-thumbnail-profile-format').value = 'jpg';
        document.getElementById('video-thumbnail-profile-quality').value = '90';
    }

    function resetImageProfileForm() {
        document.getElementById('image-profile-name').value = '';
        document.getElementById('image-profile-format').value = 'webp';
        document.getElementById('image-profile-quality').value = '90';
        document.getElementById('image-profile-compression').value = '6';
        document.getElementById('image-profile-resize').checked = false;
        document.getElementById('image-profile-width').value = '2048';
        document.getElementById('image-profile-height').value = '2048';
        document.getElementById('image-profile-maintain-aspect').checked = true;
        elements.imageResizeOptions.style.display = 'none';
        elements.imageQualityContainer.classList.remove('hidden');
        elements.imageCompressionContainer.classList.add('hidden');
    }

    function resetImageThumbnailProfileForm() {
        document.getElementById('image-thumbnail-profile-name').value = '';
        document.getElementById('image-thumbnail-profile-width').value = '320';
        document.getElementById('image-thumbnail-profile-height').value = '240';
        document.getElementById('image-thumbnail-profile-maintain-aspect').checked = true;
        document.getElementById('image-thumbnail-profile-format').value = 'webp';
        document.getElementById('image-thumbnail-profile-quality').value = '85';
    }

    // Populate form with profile data for editing
    function populateVideoProfileForm(profile) {
        document.getElementById('video-profile-name').value = profile.name || '';
        document.getElementById('video-profile-width').value = profile.width || 1280;
        document.getElementById('video-profile-height').value = profile.height || 720;
        document.getElementById('video-profile-codec').value = profile.codec || 'libx264';
        document.getElementById('video-profile-preset').value = profile.preset || 'medium';
        document.getElementById('video-profile-crf').value = profile.crf || 23;
        document.getElementById('video-profile-format').value = profile.format || 'mp4';
        document.getElementById('video-profile-audio-codec').value = profile.audio_codec || 'aac';
        document.getElementById('video-profile-audio-bitrate').value = profile.audio_bitrate || '128k';
        document.getElementById('video-profile-use-gpu').checked = profile.use_gpu !== undefined ? profile.use_gpu : true;

        if (profile.start !== undefined) {
            document.getElementById('video-profile-start').value = profile.start;
        } else {
            document.getElementById('video-profile-start').value = '';
        }

        if (profile.end !== undefined) {
            document.getElementById('video-profile-end').value = profile.end;
        } else {
            document.getElementById('video-profile-end').value = '';
        }

        elements.gpuOptionsContainer.style.display = profile.use_gpu ? 'block' : 'none';

        if (profile.gpu_options) {
            document.getElementById('video-profile-gpu-encoder').value = profile.gpu_options.hardware_encoder || 'h264_nvenc';
            document.getElementById('video-profile-gpu-preset').value = profile.gpu_options.preset || 'p4';
            document.getElementById('video-profile-gpu-rc').value = profile.gpu_options.rc || 'vbr';
        }
    }

    function populatePreviewProfileForm(profile) {
        document.getElementById('preview-profile-name').value = profile.name || '';
        document.getElementById('preview-profile-start').value = profile.start || 0;
        document.getElementById('preview-profile-end').value = profile.end || 5;
        document.getElementById('preview-profile-fps').value = profile.fps || 10;
        document.getElementById('preview-profile-width').value = profile.width || 320;
        document.getElementById('preview-profile-height').value = profile.height || 180;
        document.getElementById('preview-profile-quality').value = profile.quality || 80;
    }

    function populateVideoThumbnailProfileForm(profile) {
        document.getElementById('video-thumbnail-profile-name').value = profile.name || '';
        document.getElementById('video-thumbnail-profile-width').value = profile.width || 320;
        document.getElementById('video-thumbnail-profile-height').value = profile.height || 180;
        document.getElementById('video-thumbnail-profile-format').value = profile.format || 'jpg';
        document.getElementById('video-thumbnail-profile-quality').value = profile.quality || 90;
    }

    function populateImageProfileForm(profile) {
        document.getElementById('image-profile-name').value = profile.name || '';
        document.getElementById('image-profile-format').value = profile.format || 'webp';

        if (profile.format === 'png') {
            document.getElementById('image-profile-compression').value = profile.compression_level || 6;
            elements.imageQualityContainer.classList.add('hidden');
            elements.imageCompressionContainer.classList.remove('hidden');
        } else {
            document.getElementById('image-profile-quality').value = profile.quality || 90;
            elements.imageQualityContainer.classList.remove('hidden');
            elements.imageCompressionContainer.classList.add('hidden');
        }

        const resize = profile.resize || false;
        document.getElementById('image-profile-resize').checked = resize;
        elements.imageResizeOptions.style.display = resize ? 'block' : 'none';

        if (resize) {
            document.getElementById('image-profile-width').value = profile.width || 2048;
            document.getElementById('image-profile-height').value = profile.height || 2048;
            document.getElementById('image-profile-maintain-aspect').checked = profile.maintain_aspect_ratio !== undefined ? profile.maintain_aspect_ratio : true;
        }
    }

    function populateImageThumbnailProfileForm(profile) {
        document.getElementById('image-thumbnail-profile-name').value = profile.name || '';
        document.getElementById('image-thumbnail-profile-width').value = profile.width || 320;
        document.getElementById('image-thumbnail-profile-height').value = profile.height || 240;
        document.getElementById('image-thumbnail-profile-maintain-aspect').checked = profile.maintain_aspect_ratio !== undefined ? profile.maintain_aspect_ratio : true;
        document.getElementById('image-thumbnail-profile-format').value = profile.format || 'webp';
        document.getElementById('image-thumbnail-profile-quality').value = profile.quality || 85;
    }

    // Render profile lists
    function renderVideoProfiles() {
        elements.videoProfilesContainer.innerHTML = '';

        if (!config.video_settings.transcode_profiles.length) {
            elements.videoProfilesContainer.innerHTML = '<p>No video transcode profiles defined.</p>';
            return;
        }

        config.video_settings.transcode_profiles.forEach((profile, index) => {
            const profileItem = document.createElement('div');
            profileItem.className = 'profile-item';

            const nameSpan = document.createElement('span');
            nameSpan.textContent = `${profile.name} (${profile.width}x${profile.height}, ${profile.codec})`;
            profileItem.appendChild(nameSpan);

            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'profile-item-actions';

            const editBtn = document.createElement('button');
            editBtn.className = 'btn btn-primary btn-sm';
            editBtn.textContent = 'Edit';
            editBtn.addEventListener('click', () => {
                currentEditingIndex = index;
                currentProfileType = 'video';
                populateVideoProfileForm(profile);
                openModal(elements.videoProfileModal);
            });
            actionsDiv.appendChild(editBtn);

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'btn btn-danger btn-sm';
            deleteBtn.textContent = 'Delete';
            deleteBtn.addEventListener('click', () => {
                if (confirm('Are you sure you want to delete this profile?')) {
                    config.video_settings.transcode_profiles.splice(index, 1);
                    renderVideoProfiles();
                    updateJsonPreview();
                }
            });
            actionsDiv.appendChild(deleteBtn);

            profileItem.appendChild(actionsDiv);
            elements.videoProfilesContainer.appendChild(profileItem);
        });
    }

    function renderPreviewProfiles() {
        elements.previewProfilesContainer.innerHTML = '';

        if (!config.video_settings.preview_settings.profiles.length) {
            elements.previewProfilesContainer.innerHTML = '<p>No preview profiles defined.</p>';
            return;
        }

        config.video_settings.preview_settings.profiles.forEach((profile, index) => {
            const profileItem = document.createElement('div');
            profileItem.className = 'profile-item';

            const nameSpan = document.createElement('span');
            nameSpan.textContent = `${profile.name} (${profile.width}x${profile.height}, ${profile.start}s-${profile.end}s at ${profile.fps}fps)`;
            profileItem.appendChild(nameSpan);

            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'profile-item-actions';

            const editBtn = document.createElement('button');
            editBtn.className = 'btn btn-primary btn-sm';
            editBtn.textContent = 'Edit';
            editBtn.addEventListener('click', () => {
                currentEditingIndex = index;
                populatePreviewProfileForm(profile);
                openModal(elements.previewProfileModal);
            });
            actionsDiv.appendChild(editBtn);

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'btn btn-danger btn-sm';
            deleteBtn.textContent = 'Delete';
            deleteBtn.addEventListener('click', () => {
                if (confirm('Are you sure you want to delete this profile?')) {
                    config.video_settings.preview_settings.profiles.splice(index, 1);
                    renderPreviewProfiles();
                    updateJsonPreview();
                }
            });
            actionsDiv.appendChild(deleteBtn);

            profileItem.appendChild(actionsDiv);
            elements.previewProfilesContainer.appendChild(profileItem);
        });
    }

    function renderVideoThumbnailProfiles() {
        elements.videoThumbnailProfilesContainer.innerHTML = '';

        if (!config.video_settings.thumbnail_settings.profiles.length) {
            elements.videoThumbnailProfilesContainer.innerHTML = '<p>No video thumbnail profiles defined.</p>';
            return;
        }

        config.video_settings.thumbnail_settings.profiles.forEach((profile, index) => {
            const profileItem = document.createElement('div');
            profileItem.className = 'profile-item';

            const nameSpan = document.createElement('span');
            nameSpan.textContent = `${profile.name} (${profile.width}x${profile.height}, ${profile.format})`;
            profileItem.appendChild(nameSpan);

            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'profile-item-actions';

            const editBtn = document.createElement('button');
            editBtn.className = 'btn btn-primary btn-sm';
            editBtn.textContent = 'Edit';
            editBtn.addEventListener('click', () => {
                currentEditingIndex = index;
                populateVideoThumbnailProfileForm(profile);
                openModal(elements.videoThumbnailProfileModal);
            });
            actionsDiv.appendChild(editBtn);

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'btn btn-danger btn-sm';
            deleteBtn.textContent = 'Delete';
            deleteBtn.addEventListener('click', () => {
                if (confirm('Are you sure you want to delete this profile?')) {
                    config.video_settings.thumbnail_settings.profiles.splice(index, 1);
                    renderVideoThumbnailProfiles();
                    updateJsonPreview();
                }
            });
            actionsDiv.appendChild(deleteBtn);

            profileItem.appendChild(actionsDiv);
            elements.videoThumbnailProfilesContainer.appendChild(profileItem);
        });
    }

    function renderImageProfiles() {
        elements.imageProfilesContainer.innerHTML = '';

        if (!config.image_settings.transcode_profiles.length) {
            elements.imageProfilesContainer.innerHTML = '<p>No image transcode profiles defined.</p>';
            return;
        }

        config.image_settings.transcode_profiles.forEach((profile, index) => {
            const profileItem = document.createElement('div');
            profileItem.className = 'profile-item';

            const nameSpan = document.createElement('span');
            let qualityInfo = '';
            if (profile.format === 'png') {
                qualityInfo = `, compression: ${profile.compression_level || 6}`;
            } else {
                qualityInfo = `, quality: ${profile.quality || 90}`;
            }

            let resizeInfo = '';
            if (profile.resize) {
                resizeInfo = `, resize: ${profile.width || 2048}x${profile.height || 2048}`;
                if (profile.maintain_aspect_ratio) {
                    resizeInfo += ' (maintain aspect)';
                }
            }

            nameSpan.textContent = `${profile.name} (${profile.format}${qualityInfo}${resizeInfo})`;
            profileItem.appendChild(nameSpan);

            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'profile-item-actions';

            const editBtn = document.createElement('button');
            editBtn.className = 'btn btn-primary btn-sm';
            editBtn.textContent = 'Edit';
            editBtn.addEventListener('click', () => {
                currentEditingIndex = index;
                currentProfileType = 'image';
                populateImageProfileForm(profile);
                openModal(elements.imageProfileModal);
            });
            actionsDiv.appendChild(editBtn);

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'btn btn-danger btn-sm';
            deleteBtn.textContent = 'Delete';
            deleteBtn.addEventListener('click', () => {
                if (confirm('Are you sure you want to delete this profile?')) {
                    config.image_settings.transcode_profiles.splice(index, 1);
                    renderImageProfiles();
                    updateJsonPreview();
                }
            });
            actionsDiv.appendChild(deleteBtn);

            profileItem.appendChild(actionsDiv);
            elements.imageProfilesContainer.appendChild(profileItem);
        });
    }


</script>
{% endblock %}